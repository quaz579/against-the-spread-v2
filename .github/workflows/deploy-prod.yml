name: Deploy to Prod

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'infrastructure/terraform/**'
  # Run after successful terraform apply when infrastructure changes
  workflow_run:
    workflows: ["Terraform Apply"]
    types:
      - completed
    branches:
      - main
  # Allow calling from other workflows
  workflow_call:
  # Allow manual trigger
  workflow_dispatch:

concurrency:
  group: deploy-prod-${{ github.ref }}
  cancel-in-progress: true

env:
  DOTNET_VERSION: '8.0.x'

jobs:
  build_and_deploy:
    # Run on: push to main (non-terraform), manual dispatch, workflow_call,
    # or after successful terraform apply (workflow_run)
    if: |
      (github.event_name == 'push') ||
      (github.event_name == 'workflow_dispatch') ||
      (github.event_name == 'workflow_call') ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    runs-on: ubuntu-latest
    name: Build and Deploy to Prod
    environment:
      name: production
      url: https://ashy-pebble-07e5d0b10.2.azurestaticapps.net
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
          lfs: false
          # For workflow_run, checkout the branch that triggered terraform-apply
          ref: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_branch || '' }}

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Build and Publish Web Project
        run: dotnet publish src/AgainstTheSpread.Web/AgainstTheSpread.Web.csproj -c Release -o publish/web

      - name: Build and Publish Functions Project
        run: dotnet publish src/AgainstTheSpread.Functions/AgainstTheSpread.Functions.csproj -c Release -o publish/api

      - name: Copy staticwebapp.config.json to wwwroot
        run: cp src/AgainstTheSpread.Web/wwwroot/staticwebapp.config.json publish/web/wwwroot/

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install SWA CLI
        run: npm install -g @azure/static-web-apps-cli

      - name: Deploy to Azure Static Web Apps
        run: |
          swa deploy ./publish/web/wwwroot \
            --api-location ./publish/api \
            --api-language dotnet \
            --api-version 8.0 \
            --deployment-token "${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_PROD }}" \
            --env production
        env:
          SWA_CLI_DEPLOYMENT_TOKEN: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_PROD }}
