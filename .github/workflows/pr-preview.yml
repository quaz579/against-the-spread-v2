name: PR Preview & E2E Tests

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]
    branches:
      - main

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: pr-preview-${{ github.event.pull_request.number }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  SWA_NAME: 'swa-dev-cus-atsv2'
  RESOURCE_GROUP: 'rg-dev-cus-atsv2'

jobs:
  # Deploy PR preview environment (Azure builds the code)
  deploy_preview:
    if: github.event.action != 'closed'
    runs-on: ubuntu-latest
    name: Deploy PR Preview
    outputs:
      preview_url: ${{ steps.deploy.outputs.static_web_app_url }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
          lfs: false

      # Azure login for cleanup step
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: '{"clientId":"${{ secrets.ARM_CLIENT_ID }}","clientSecret":"${{ secrets.ARM_CLIENT_SECRET }}","subscriptionId":"${{ secrets.ARM_SUBSCRIPTION_ID }}","tenantId":"${{ secrets.ARM_TENANT_ID }}"}'

      # Cleanup orphaned staging environments (Free tier limit: 3)
      # This finds staging envs for PRs that no longer exist and deletes them
      - name: Cleanup orphaned staging environments
        run: |
          echo "Checking for orphaned staging environments..."

          # Get list of staging environments (excluding 'default' production)
          ENVS=$(az staticwebapp environment list \
            --name ${{ env.SWA_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query "[?name!='default'].name" -o tsv)

          echo "Found staging environments: $ENVS"

          # Get open PR numbers from GitHub API
          OPEN_PRS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/pulls?state=open" \
            | jq -r '.[].number')

          echo "Open PR numbers: $OPEN_PRS"

          for ENV in $ENVS; do
            # Extract PR number from environment name (e.g., "pr13" -> "13")
            if [[ $ENV =~ ^pr([0-9]+)$ ]]; then
              PR_NUM="${BASH_REMATCH[1]}"

              # Check if this PR is still open
              if ! echo "$OPEN_PRS" | grep -q "^${PR_NUM}$"; then
                echo "Deleting orphaned environment '$ENV' (PR #$PR_NUM is closed)"
                az staticwebapp environment delete \
                  --name ${{ env.SWA_NAME }} \
                  --resource-group ${{ env.RESOURCE_GROUP }} \
                  --environment-name "$ENV" \
                  --yes || echo "Warning: Failed to delete environment $ENV"
              else
                echo "Keeping environment '$ENV' (PR #$PR_NUM is still open)"
              fi
            else
              # Non-PR environments (branch deployments) - check if older than 7 days
              echo "Found non-PR environment: $ENV (keeping)"
            fi
          done

          echo "Cleanup complete"

      - name: Deploy to PR Preview Environment
        id: deploy
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_DEV }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: 'upload'
          app_location: 'src/AgainstTheSpread.Web'
          api_location: 'src/AgainstTheSpread.Functions'
          output_location: 'wwwroot'

      - name: Output Preview URL
        run: |
          echo "Preview URL: ${{ steps.deploy.outputs.static_web_app_url }}"

      - name: Comment Preview URL on PR
        uses: actions/github-script@v7
        with:
          script: |
            const previewUrl = '${{ steps.deploy.outputs.static_web_app_url }}';
            const body = `## ðŸš€ PR Preview Deployed

            | Environment | URL |
            |-------------|-----|
            | Preview | [${previewUrl}](${previewUrl}) |

            The preview environment will be automatically cleaned up when this PR is closed.

            ---
            *This comment will be updated with E2E test results when they complete.*`;

            // Find existing preview comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const existingComment = comments.find(c =>
              c.user.login === 'github-actions[bot]' &&
              c.body.includes('ðŸš€ PR Preview Deployed')
            );

            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

  # Run E2E tests against preview
  e2e_tests:
    needs: deploy_preview
    runs-on: ubuntu-latest
    name: E2E Tests
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Playwright dependencies
        working-directory: tests
        run: |
          npm ci
          npx playwright install --with-deps chromium

      - name: Wait for preview deployment to be ready
        run: |
          PREVIEW_URL="${{ needs.deploy_preview.outputs.preview_url }}"
          echo "Waiting for $PREVIEW_URL to be ready..."

          # Wait up to 5 minutes for deployment to be accessible
          for i in {1..30}; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$PREVIEW_URL" || echo "000")
            if [[ "$HTTP_CODE" =~ ^(200|301|302)$ ]]; then
              echo "Preview is ready! (HTTP $HTTP_CODE)"
              exit 0
            fi
            echo "Attempt $i/30: Preview not ready yet (HTTP $HTTP_CODE), waiting 10 seconds..."
            sleep 10
          done

          echo "Preview deployment failed to become ready after 5 minutes"
          exit 1

      - name: Run Playwright E2E tests
        working-directory: tests
        run: npx playwright test --reporter=list,html
        env:
          BASE_URL: ${{ needs.deploy_preview.outputs.preview_url }}
          CI: true

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-pr-${{ github.event.pull_request.number }}
          path: tests/playwright-report/
          retention-days: 7

      - name: Update PR comment with E2E results
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const previewUrl = '${{ needs.deploy_preview.outputs.preview_url }}';
            const testResult = '${{ job.status }}';
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            const statusEmoji = testResult === 'success' ? 'âœ…' : 'âŒ';
            const statusText = testResult === 'success' ? 'Passed' : 'Failed';

            const body = `## ðŸš€ PR Preview Deployed

            | Environment | URL |
            |-------------|-----|
            | Preview | [${previewUrl}](${previewUrl}) |

            ## ${statusEmoji} E2E Test Results: ${statusText}

            | Test Suite | Status |
            |------------|--------|
            | Playwright E2E | ${statusEmoji} ${statusText} |

            [View Full Test Report](${runUrl}) | [Download Artifacts](${runUrl}#artifacts)

            The preview environment will be automatically cleaned up when this PR is closed.`;

            // Find existing preview comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const existingComment = comments.find(c =>
              c.user.login === 'github-actions[bot]' &&
              c.body.includes('ðŸš€ PR Preview Deployed')
            );

            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

  # Cleanup preview environment when PR is closed
  cleanup_preview:
    if: github.event.action == 'closed'
    runs-on: ubuntu-latest
    name: Cleanup Preview
    steps:
      - name: Close Pull Request Preview
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_DEV }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: 'close'
