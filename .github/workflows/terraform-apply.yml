name: Terraform Apply

on:
  push:
    branches:
      - main
    paths:
      - 'infrastructure/terraform/**'
      - '.github/workflows/terraform-apply.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to apply (dev, prod, or both)'
        required: true
        default: 'both'
        type: choice
        options:
          - dev
          - prod
          - both

permissions:
  contents: read

env:
  TF_WORKING_DIR: infrastructure/terraform
  ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
  ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
  ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
  ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}

jobs:
  apply-dev:
    name: Apply Dev Environment
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' ||
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.environment == 'dev' || github.event.inputs.environment == 'both'))
    outputs:
      result: ${{ steps.apply.outcome }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: '1.6.0'
          tofu_wrapper: false

      - name: Tofu Init (Dev)
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          tofu init \
            -backend-config="key=dev.terraform.tfstate"

      - name: Tofu Apply (Dev)
        id: apply
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          tofu apply \
            -var-file="dev.tfvars" \
            -var="sql_admin_login=${{ secrets.TF_VAR_SQL_ADMIN_LOGIN }}" \
            -var="sql_admin_password=${{ secrets.TF_VAR_SQL_ADMIN_PASSWORD }}" \
            -var="admin_emails=${{ secrets.TF_VAR_ADMIN_EMAILS_DEV }}" \
            -var="cfbd_api_key=${{ secrets.TF_VAR_CFBD_API_KEY }}" \
            -auto-approve

  apply-prod:
    name: Apply Prod Environment
    runs-on: ubuntu-latest
    needs: apply-dev
    if: |
      always() &&
      (needs.apply-dev.result == 'success' || needs.apply-dev.result == 'skipped') &&
      (github.event_name == 'push' ||
       (github.event_name == 'workflow_dispatch' && (github.event.inputs.environment == 'prod' || github.event.inputs.environment == 'both')))
    # NO environment protection - dev apply success IS the approval gate for prod
    outputs:
      result: ${{ steps.apply.outcome }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: '1.6.0'
          tofu_wrapper: false

      - name: Tofu Init (Prod)
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          tofu init \
            -backend-config="key=prod.terraform.tfstate"

      - name: Tofu Apply (Prod)
        id: apply
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          tofu apply \
            -var-file="prod.tfvars" \
            -var="sql_admin_login=${{ secrets.TF_VAR_SQL_ADMIN_LOGIN }}" \
            -var="sql_admin_password=${{ secrets.TF_VAR_SQL_ADMIN_PASSWORD }}" \
            -var="admin_emails=${{ secrets.TF_VAR_ADMIN_EMAILS_PROD }}" \
            -var="cfbd_api_key=${{ secrets.TF_VAR_CFBD_API_KEY }}" \
            -auto-approve

  # This job provides a single status that other workflows can depend on
  terraform-status:
    name: Terraform Status
    runs-on: ubuntu-latest
    needs: [apply-dev, apply-prod]
    if: always()
    outputs:
      dev_result: ${{ needs.apply-dev.result }}
      prod_result: ${{ needs.apply-prod.result }}
      overall_success: ${{ steps.status.outputs.success }}
    steps:
      - name: Check Status
        id: status
        run: |
          if [[ "${{ needs.apply-dev.result }}" == "success" || "${{ needs.apply-dev.result }}" == "skipped" ]] && \
             [[ "${{ needs.apply-prod.result }}" == "success" || "${{ needs.apply-prod.result }}" == "skipped" ]]; then
            echo "success=true" >> $GITHUB_OUTPUT
            echo "Terraform apply completed successfully"
          else
            echo "success=false" >> $GITHUB_OUTPUT
            echo "Terraform apply failed"
            exit 1
          fi
