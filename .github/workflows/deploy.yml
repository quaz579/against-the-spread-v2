name: Build, Test & Deploy

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'infrastructure/terraform/**'
  # Run after successful terraform apply when infrastructure changes
  workflow_run:
    workflows: ["Terraform Apply"]
    types:
      - completed
    branches:
      - main
  # Allow calling from other workflows
  workflow_call:
  # Allow manual trigger
  workflow_dispatch:

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

env:
  DOTNET_VERSION: '8.0.x'
  NODE_VERSION: '20'
  DEV_URL: 'https://blue-smoke-0b4410710.2.azurestaticapps.net'
  PROD_URL: 'https://ashy-pebble-07e5d0b10.2.azurestaticapps.net'
  # SQL Server details for EF migrations
  DEV_SQL_SERVER: sql-dev-cus-atsv2
  DEV_SQL_DATABASE: sqldb-dev-cus-atsv2
  DEV_RESOURCE_GROUP: rg-dev-cus-atsv2
  PROD_SQL_SERVER: sql-prod-cus-atsv2
  PROD_SQL_DATABASE: sqldb-prod-cus-atsv2
  PROD_RESOURCE_GROUP: rg-prod-cus-atsv2

jobs:
  # Job 1: Run all unit tests
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    # Skip if workflow_run didn't succeed
    if: |
      (github.event_name != 'workflow_run') ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
          lfs: false
          ref: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_branch || '' }}

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore dependencies
        run: dotnet restore

      - name: Build
        run: dotnet build --no-restore

      - name: Run unit tests
        run: dotnet test --no-build --verbosity normal

      # Build EF Migrations Bundle for deployment
      - name: Install EF Core tools
        run: dotnet tool install --global dotnet-ef

      - name: Build Migrations Bundle
        run: |
          dotnet ef migrations bundle \
            --project src/AgainstTheSpread.Data \
            --startup-project src/AgainstTheSpread.Functions \
            --configuration Release \
            --output ./efbundle \
            --self-contained \
            -r linux-x64 \
            --force

      - name: Upload Migrations Bundle
        uses: actions/upload-artifact@v4
        with:
          name: ef-migrations
          path: ./efbundle
          retention-days: 1

  # Job 2: Migrate Dev Database
  migrate-dev:
    name: Migrate Dev DB
    needs: unit-tests
    runs-on: ubuntu-latest
    steps:
      - name: Download Migrations Bundle
        uses: actions/download-artifact@v4
        with:
          name: ef-migrations

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: '{"clientId":"${{ secrets.ARM_CLIENT_ID }}","clientSecret":"${{ secrets.ARM_CLIENT_SECRET }}","subscriptionId":"${{ secrets.ARM_SUBSCRIPTION_ID }}","tenantId":"${{ secrets.ARM_TENANT_ID }}"}'

      - name: Get Runner IP
        id: ip
        uses: haythem/public-ip@v1.3

      - name: Add Firewall Rule
        run: |
          az sql server firewall-rule create \
            --resource-group ${{ env.DEV_RESOURCE_GROUP }} \
            --server ${{ env.DEV_SQL_SERVER }} \
            --name GitHubActions-${{ github.run_id }} \
            --start-ip-address ${{ steps.ip.outputs.ipv4 }} \
            --end-ip-address ${{ steps.ip.outputs.ipv4 }}
          echo "Waiting 30s for firewall rule to propagate..."
          sleep 30

      - name: Apply Migrations to Dev
        run: |
          chmod +x ./efbundle
          ./efbundle --connection "Server=tcp:${{ env.DEV_SQL_SERVER }}.database.windows.net,1433;Initial Catalog=${{ env.DEV_SQL_DATABASE }};Persist Security Info=False;User ID=${{ secrets.TF_VAR_SQL_ADMIN_LOGIN }};Password=${{ secrets.TF_VAR_SQL_ADMIN_PASSWORD }};MultipleActiveResultSets=False;Encrypt=True;TrustServerCertificate=False;Connection Timeout=30;"
        timeout-minutes: 5

      - name: Remove Firewall Rule
        if: always()
        run: |
          az sql server firewall-rule delete \
            --resource-group ${{ env.DEV_RESOURCE_GROUP }} \
            --server ${{ env.DEV_SQL_SERVER }} \
            --name GitHubActions-${{ github.run_id }} \
            --yes

  # Job 3: Deploy to Dev environment (Azure builds the code)
  deploy-dev:
    name: Deploy to Dev
    needs: migrate-dev
    runs-on: ubuntu-latest
    outputs:
      dev_url: ${{ env.DEV_URL }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
          lfs: false
          ref: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_branch || '' }}

      # Modify staticwebapp.config.json to allow anonymous access to API routes
      # This enables test auth bypass (X-Test-User-Email header) for E2E tests
      # Function code still validates auth - this just allows requests through SWA platform layer
      # IMPORTANT: This modification is DEV ONLY - prod uses the original authenticated-only config
      - name: Enable test auth bypass for Dev
        run: |
          CONFIG_FILE="src/AgainstTheSpread.Web/wwwroot/staticwebapp.config.json"
          echo "Modifying $CONFIG_FILE to allow anonymous access for test auth bypass..."

          # Use jq to add "anonymous" to allowedRoles arrays for API routes
          jq '
            .routes = [.routes[] |
              if (.route | test("^/api/")) then
                .allowedRoles = ((.allowedRoles // []) + ["anonymous"] | unique)
              else
                .
              end
            ]
          ' "$CONFIG_FILE" > tmp.json && mv tmp.json "$CONFIG_FILE"

          echo "Modified config:"
          cat "$CONFIG_FILE"

      - name: Deploy to Azure Static Web Apps (Dev)
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_DEV }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: 'upload'
          app_location: 'src/AgainstTheSpread.Web'
          api_location: 'src/AgainstTheSpread.Functions'
          output_location: 'wwwroot'

      - name: Output Dev URL
        run: echo "Deployed to ${{ env.DEV_URL }}"

  # Job 3: Wait for Dev deployment to be ready
  wait-for-dev:
    name: Wait for Dev
    needs: deploy-dev
    runs-on: ubuntu-latest
    steps:
      - name: Wait for dev deployment to be accessible
        run: |
          DEV_URL="${{ env.DEV_URL }}"
          echo "Waiting for $DEV_URL to be ready..."

          for i in {1..30}; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$DEV_URL" || echo "000")
            if [[ "$HTTP_CODE" =~ ^(200|301|302)$ ]]; then
              echo "Dev environment is ready! (HTTP $HTTP_CODE)"
              exit 0
            fi
            echo "Attempt $i/30: Dev not ready yet (HTTP $HTTP_CODE), waiting 10 seconds..."
            sleep 10
          done

          echo "Dev deployment failed to become accessible after 5 minutes"
          exit 1

  # Job 4: Run E2E tests against Dev environment
  e2e-tests:
    name: E2E Tests (Dev)
    needs: [deploy-dev, wait-for-dev]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_branch || '' }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Playwright dependencies
        working-directory: tests
        run: |
          npm ci
          npx playwright install --with-deps chromium

      - name: Run Playwright E2E tests against Dev
        working-directory: tests
        run: npx playwright test --reporter=list,html
        env:
          BASE_URL: ${{ env.DEV_URL }}
          CI: true

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: tests/playwright-report/
          retention-days: 7

      - name: Upload test artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-artifacts
          path: tests/test-results/
          retention-days: 7

  # Job 5: Migrate Prod Database
  migrate-prod:
    name: Migrate Prod DB
    needs: e2e-tests
    runs-on: ubuntu-latest
    steps:
      - name: Download Migrations Bundle
        uses: actions/download-artifact@v4
        with:
          name: ef-migrations

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: '{"clientId":"${{ secrets.ARM_CLIENT_ID }}","clientSecret":"${{ secrets.ARM_CLIENT_SECRET }}","subscriptionId":"${{ secrets.ARM_SUBSCRIPTION_ID }}","tenantId":"${{ secrets.ARM_TENANT_ID }}"}'

      - name: Get Runner IP
        id: ip
        uses: haythem/public-ip@v1.3

      - name: Add Firewall Rule
        run: |
          az sql server firewall-rule create \
            --resource-group ${{ env.PROD_RESOURCE_GROUP }} \
            --server ${{ env.PROD_SQL_SERVER }} \
            --name GitHubActions-${{ github.run_id }} \
            --start-ip-address ${{ steps.ip.outputs.ipv4 }} \
            --end-ip-address ${{ steps.ip.outputs.ipv4 }}
          echo "Waiting 30s for firewall rule to propagate..."
          sleep 30

      - name: Apply Migrations to Prod
        run: |
          chmod +x ./efbundle
          ./efbundle --connection "Server=tcp:${{ env.PROD_SQL_SERVER }}.database.windows.net,1433;Initial Catalog=${{ env.PROD_SQL_DATABASE }};Persist Security Info=False;User ID=${{ secrets.TF_VAR_SQL_ADMIN_LOGIN }};Password=${{ secrets.TF_VAR_SQL_ADMIN_PASSWORD }};MultipleActiveResultSets=False;Encrypt=True;TrustServerCertificate=False;Connection Timeout=30;"
        timeout-minutes: 5

      - name: Remove Firewall Rule
        if: always()
        run: |
          az sql server firewall-rule delete \
            --resource-group ${{ env.PROD_RESOURCE_GROUP }} \
            --server ${{ env.PROD_SQL_SERVER }} \
            --name GitHubActions-${{ github.run_id }} \
            --yes

  # Job 6: Deploy to Prod (automatic after E2E passes, Azure builds the code)
  deploy-prod:
    name: Deploy to Prod
    needs: migrate-prod
    runs-on: ubuntu-latest
    # NO environment protection - E2E tests passing IS the approval gate
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
          lfs: false
          ref: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_branch || '' }}

      - name: Deploy to Azure Static Web Apps (Prod)
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_PROD }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: 'upload'
          app_location: 'src/AgainstTheSpread.Web'
          api_location: 'src/AgainstTheSpread.Functions'
          output_location: 'wwwroot'

      - name: Output Prod URL
        run: echo "Deployed to ${{ env.PROD_URL }}"
