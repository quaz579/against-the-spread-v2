@page "/picks"
@using AgainstTheSpread.Core.Models
@using AgainstTheSpread.Web.Services
@using AgainstTheSpread.Web.Models
@using Microsoft.JSInterop
@inject ApiService ApiService
@inject ITeamLogoService TeamLogoService
@inject ITeamColorService TeamColorService
@inject IAuthenticationService AuthService
@inject HttpClient HttpClient
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation
@inject ILogger<Picks> Logger

<PageTitle>Make Your Picks - Against The Spread</PageTitle>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>üèà Make Your Weekly Picks</h1>
        
        <!-- Optional Google Login -->
        @if (!isAuthCheckComplete)
        {
            <div class="spinner-border spinner-border-sm text-secondary" role="status">
                <span class="visually-hidden">Checking auth...</span>
            </div>
        }
        else if (isAuthenticated)
        {
            <div class="d-flex align-items-center gap-2">
                <span class="text-muted small">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-person-circle me-1" viewBox="0 0 16 16">
                        <path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0z"/>
                        <path fill-rule="evenodd" d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8zm8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1z"/>
                    </svg>
                    @userEmail
                </span>
                <button class="btn btn-outline-secondary btn-sm" @onclick="Logout">Sign Out</button>
            </div>
        }
        else
        {
            <button class="btn btn-outline-primary btn-sm" @onclick="Login">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-google me-1" viewBox="0 0 16 16">
                    <path d="M15.545 6.558a9.4 9.4 0 0 1 .139 1.626c0 2.434-.87 4.492-2.384 5.885h.002C11.978 15.292 10.158 16 8 16A8 8 0 1 1 8 0a7.7 7.7 0 0 1 5.352 2.082l-2.284 2.284A4.35 4.35 0 0 0 8 3.166c-2.087 0-3.86 1.408-4.492 3.304a4.8 4.8 0 0 0 0 3.063h.003c.635 1.893 2.405 3.301 4.492 3.301 1.078 0 2.004-.276 2.722-.764h-.003a3.7 3.7 0 0 0 1.599-2.431H8v-3.08z"/>
                </svg>
                Sign in with Google
            </button>
        }
    </div>

    @if (isLoading)
    {
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading games...</p>
        </div>
    }
    else if (errorMessage != null)
    {
        <div class="alert alert-danger" role="alert">
            <strong>Error:</strong> @errorMessage
        </div>
        <button class="btn btn-primary" @onclick="LoadAvailableWeeks">Retry</button>
    }
    else if (currentWeekLines == null)
    {
        <!-- Week Selection -->
        <div class="card mb-4">
            <div class="card-body">
                <h3 class="card-title">Select Week and Enter Your Name</h3>

                <div class="mb-3">
                    <label for="userName" class="form-label">Your Name</label>
                    <input type="text" class="form-control" id="userName" @bind="userName"
                        placeholder="Enter your full name" />
                </div>

                <div class="mb-3">
                    <label for="year" class="form-label">Season</label>
                    <select class="form-select" id="year" @bind="selectedYear" @bind:after="LoadAvailableWeeks">
                        <option value="2024">2024</option>
                        <option value="2025">2025</option>
                        <option value="2026">2026</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label for="week" class="form-label">Week</label>
                    <select class="form-select" id="week" @bind="selectedWeek" disabled="@(availableWeeks.Count == 0)">
                        <option value="0">-- Select Week --</option>
                        @foreach (var week in availableWeeks)
                        {
                            <option value="@week">Week @week</option>
                        }
                    </select>
                </div>

                <button class="btn btn-primary btn-lg" @onclick="LoadGames"
                    disabled="@(string.IsNullOrWhiteSpace(userName) || selectedWeek == 0)">
                    Continue to Picks
                </button>
            </div>
        </div>
    }
    else
    {
        <!-- Game Selection -->
        <div class="mb-3">
            <button class="btn btn-secondary" @onclick="GoBack">
                ‚Üê Back to Week Selection
            </button>
        </div>

        <div class="alert alert-info" role="alert">
            <strong>@userName</strong> - Week @selectedWeek, @selectedYear
            <br />
            <strong>Selected: @selectedPicks.Count / 6 picks</strong>
            @if (selectedPicks.Count == 6)
            {
                <span class="text-success ms-2">‚úì Ready to download!</span>
            }
        </div>

        <div class="row">
            @foreach (var game in currentWeekLines.Games)
            {
                var isFavoriteSelected = selectedPicks.Contains(game.Favorite);
                var isUnderdogSelected = selectedPicks.Contains(game.Underdog);
                var gameDate = game.GameDate.ToString("ddd M/d, h:mm tt");
                var favoriteColors = TeamColorService.GetTeamColors(game.Favorite);
                var underdogColors = TeamColorService.GetTeamColors(game.Underdog);

                <div class="col-md-6 col-lg-4 mb-3">
                    <div class="card h-100">
                        <div class="card-body">
                            <small class="text-muted">@gameDate</small>
                            <div class="d-grid gap-2 mt-2">
                                <button class="btn @GetButtonClass(isFavoriteSelected, favoriteColors)"
                                    style="@GetButtonStyle(isFavoriteSelected, favoriteColors)"
                                    @onclick="() => TogglePick(game.Favorite)"
                                    disabled="@(!isFavoriteSelected && selectedPicks.Count >= 6)">
                                    <TeamLogo TeamName="@game.Favorite"
                                        Style="width: 20px; height: 20px; object-fit: contain; margin-right: 6px; vertical-align: middle;" />
                                    @game.FavoriteDisplay
                                    @if (isFavoriteSelected)
                                    {
                                        <span>‚úì</span>
                                    }
                                </button>

                                <div class="text-center">
                                    <small class="text-muted">@game.VsAt</small>
                                </div>

                                <button class="btn @GetButtonClass(isUnderdogSelected, underdogColors)"
                                    style="@GetButtonStyle(isUnderdogSelected, underdogColors)"
                                    @onclick="() => TogglePick(game.Underdog)"
                                    disabled="@(!isUnderdogSelected && selectedPicks.Count >= 6)">
                                    <TeamLogo TeamName="@game.Underdog"
                                        Style="width: 20px; height: 20px; object-fit: contain; margin-right: 6px; vertical-align: middle;" />
                                    @game.UnderdogDisplay
                                    @if (isUnderdogSelected)
                                    {
                                        <span>‚úì</span>
                                    }
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>

        @if (selectedPicks.Count == 6)
        {
            <div class="fixed-bottom bg-white border-top p-3 shadow">
                <div class="container">
                    @if (!showDeliveryOptions)
                    {
                        <div class="d-grid">
                            <button class="btn btn-success btn-lg" @onclick="GeneratePicks" disabled="@isDownloading">
                                @if (isDownloading)
                                {
                                    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                    <span>Generating Excel...</span>
                                }
                                else
                                {
                                    <span>üì• Generate Your Picks</span>
                                }
                            </button>
                        </div>
                    }
                    else
                    {
                        <!-- Delivery Options for Authenticated Users -->
                        <div class="mb-2">
                            <strong>Your picks are ready! How would you like to proceed?</strong>
                        </div>
                        <div class="d-grid gap-2">
                            @if (isAuthenticated)
                            {
                                <button class="btn btn-primary" @onclick="DownloadOnly">
                                    üì• Download File
                                </button>
                                <button class="btn btn-info" @onclick="OpenGmailOnly">
                                    ‚úâÔ∏è Open in Gmail (manual attach)
                                </button>
                                <button class="btn btn-success" @onclick="DownloadAndGmail">
                                    üì• + ‚úâÔ∏è Download & Open Gmail
                                </button>
                            }
                            else
                            {
                                <button class="btn btn-success" @onclick="DownloadOnly">
                                    üì• Download File
                                </button>
                            }
                            <button class="btn btn-outline-secondary" @onclick="CancelDelivery">
                                Cancel
                            </button>
                        </div>
                    }
                </div>
            </div>
        }
    }
</div>

@code {
    private string userName = "";
    private int selectedYear = DateTime.Now.Year;
    private int selectedWeek = 0;
    private List<int> availableWeeks = new();
    private WeeklyLines? currentWeekLines = null;
    private List<string> selectedPicks = new();
    private bool isLoading = true;
    private bool isDownloading = false;
    private string? errorMessage = null;
    
    // Authentication state
    private bool isAuthCheckComplete = false;
    private bool isAuthenticated = false;
    private string? userEmail = null;
    
    // Delivery options
    private bool showDeliveryOptions = false;
    private byte[]? generatedExcelBytes = null;
    private string? generatedFileName = null;

    protected override async Task OnInitializedAsync()
    {
        // Check authentication status
        await CheckAuthStatus();
        
        // Initialize the team logo service and team color service
        await TeamLogoService.InitializeAsync(HttpClient);
        await TeamColorService.InitializeAsync(HttpClient);

        await LoadAvailableWeeks();
    }

    private async Task LoadAvailableWeeks()
    {
        isLoading = true;
        errorMessage = null;

        try
        {
            availableWeeks = await ApiService.GetAvailableWeeksAsync(selectedYear);

            if (availableWeeks.Count == 0)
            {
                errorMessage = $"No weeks available for {selectedYear}. Please check back later or contact your administrator.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load available weeks: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadGames()
    {
        if (string.IsNullOrWhiteSpace(userName) || selectedWeek == 0)
            return;

        isLoading = true;
        errorMessage = null;

        try
        {
            currentWeekLines = await ApiService.GetLinesAsync(selectedWeek, selectedYear);

            if (currentWeekLines == null)
            {
                errorMessage = $"Could not load games for Week {selectedWeek}. Please try again.";
                currentWeekLines = null;
            }
            else
            {
                selectedPicks.Clear();
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load games: {ex.Message}";
            currentWeekLines = null;
        }
        finally
        {
            isLoading = false;
        }
    }

    private void GoBack()
    {
        currentWeekLines = null;
        selectedPicks.Clear();
    }

    private void TogglePick(string team)
    {
        if (selectedPicks.Contains(team))
        {
            selectedPicks.Remove(team);
        }
        else if (selectedPicks.Count < 6)
        {
            selectedPicks.Add(team);
        }
    }

    private async Task CheckAuthStatus()
    {
        try
        {
            var userInfo = await AuthService.GetUserInfoAsync();
            isAuthenticated = userInfo?.IsAuthenticated ?? false;
            userEmail = userInfo?.Email;
        }
        catch (HttpRequestException ex)
        {
            Logger.LogError(ex, "Network/auth error checking auth status");
            isAuthenticated = false;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Unexpected error checking auth status");
            isAuthenticated = false;
        }
        finally
        {
            isAuthCheckComplete = true;
        }
    }

    private void Login()
    {
        Navigation.NavigateTo("/.auth/login/google?post_login_redirect_uri=/picks", true);
    }

    private void Logout()
    {
        // Clear cached authentication info before logout
        AuthService.ClearCache();
        Navigation.NavigateTo("/.auth/logout?post_logout_redirect_uri=/picks", true);
    }

    private async Task GeneratePicks()
    {
        if (selectedPicks.Count != 6)
            return;

        isDownloading = true;

        try
        {
            var userPicks = new UserPicks
            {
                Name = userName,
                Week = selectedWeek,
                Year = selectedYear,
                Picks = selectedPicks,
                SubmittedAt = DateTime.UtcNow
            };

            var excelBytes = await ApiService.SubmitPicksAsync(userPicks);

            if (excelBytes != null)
            {
                // Store the generated file
                generatedExcelBytes = excelBytes;
                generatedFileName = $"{SanitizeFileName(userName)}_Week_{selectedWeek}_Picks.xlsx";
                
                // Show delivery options
                showDeliveryOptions = true;
            }
            else
            {
                errorMessage = "Failed to generate picks file. Please try again.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error generating picks: {ex.Message}";
        }
        finally
        {
            isDownloading = false;
        }
    }

    private string SanitizeFileName(string input)
    {
        var invalidChars = Path.GetInvalidFileNameChars();
        return string.Join("_", input.Split(invalidChars, StringSplitOptions.RemoveEmptyEntries)).TrimEnd();
    }

    private string BuildGmailComposeUrl()
    {
        var subject = Uri.EscapeDataString($"Week {selectedWeek} Picks - {userName}");
        var body = Uri.EscapeDataString($"Hi,\n\nPlease find attached my picks for Week {selectedWeek}.\n\nName: {userName}\nWeek: {selectedWeek}\nYear: {selectedYear}\n\nNote: Please attach the file '{generatedFileName}' that was just downloaded.\n\nThanks!");
        return $"https://mail.google.com/mail/?view=cm&fs=1&su={subject}&body={body}";
    }

    private async Task DownloadOnly()
    {
        if (generatedExcelBytes != null && generatedFileName != null)
        {
            await JSRuntime.InvokeVoidAsync("downloadFile", generatedFileName, Convert.ToBase64String(generatedExcelBytes));
            await JSRuntime.InvokeVoidAsync("alert", "‚úÖ Your picks have been downloaded successfully!");
            ResetAfterDelivery();
        }
    }

    private async Task OpenGmailOnly()
    {
        // Open Gmail compose window with pre-filled information
        var gmailUrl = BuildGmailComposeUrl();
        
        await JSRuntime.InvokeVoidAsync("open", gmailUrl, "_blank");
        await JSRuntime.InvokeVoidAsync("alert", "Gmail compose window opened! Please attach the downloaded file manually.");
        
        ResetAfterDelivery();
    }

    private async Task DownloadAndGmail()
    {
        // Download the file first
        if (generatedExcelBytes != null && generatedFileName != null)
        {
            await JSRuntime.InvokeVoidAsync("downloadFile", generatedFileName, Convert.ToBase64String(generatedExcelBytes));
            
            // Small delay to ensure browser processes the download before opening a new window.
            // This is a workaround for browser behavior and may not work reliably across all browsers or network conditions.
            await Task.Delay(500);
            
            // Then open Gmail
            var gmailUrl = BuildGmailComposeUrl();
            
            await JSRuntime.InvokeVoidAsync("open", gmailUrl, "_blank");
            await JSRuntime.InvokeVoidAsync("alert", "‚úÖ File downloaded and Gmail opened! Please attach the file to your email.");
            
            ResetAfterDelivery();
        }
    }

    private void CancelDelivery()
    {
        showDeliveryOptions = false;
        generatedExcelBytes = null;
        generatedFileName = null;
    }

    private void ResetAfterDelivery()
    {
        showDeliveryOptions = false;
        generatedExcelBytes = null;
        generatedFileName = null;
        GoBack();
    }

    private string GetButtonClass(bool isSelected, TeamColors? teamColors)
    {
        // If selected, use bright green with custom styling
        if (isSelected)
        {
            return "btn-selected";
        }

        // If no team colors, use default Bootstrap styles
        if (teamColors == null)
        {
            return "btn-outline-primary";
        }

        // Use team-colored class for unselected buttons with team colors
        return "team-color-btn";
    }

    private string GetButtonStyle(bool isSelected, TeamColors? teamColors)
    {
        // If selected, use bright green with dark border
        if (isSelected)
        {
            return "background-color: #00ff00; border: 3px solid #000000; color: #000000; font-weight: bold;";
        }

        // If no colors, don't add custom styles
        if (teamColors == null)
        {
            return string.Empty;
        }

        // Validate that colors are not empty
        if (string.IsNullOrWhiteSpace(teamColors.Primary) || string.IsNullOrWhiteSpace(teamColors.Secondary))
        {
            return string.Empty;
        }

        // Apply team colors with good contrast for text
        var brightness = GetBrightness(teamColors.Primary);
        var textColor = brightness > 128 ? "#000000" : "#FFFFFF";

        return $"background-color: {teamColors.Primary}; border-color: {teamColors.Secondary}; color: {textColor};";
    }

    private int GetBrightness(string hexColor)
    {
        try
        {
            // Remove # if present
            hexColor = hexColor.TrimStart('#');

            // Validate length
            if (hexColor.Length != 6)
            {
                return 128; // Return middle brightness as default
            }

            // Parse RGB values
            var r = Convert.ToInt32(hexColor.Substring(0, 2), 16);
            var g = Convert.ToInt32(hexColor.Substring(2, 2), 16);
            var b = Convert.ToInt32(hexColor.Substring(4, 2), 16);

            // Calculate perceived brightness using standard formula
            return (int)((r * 299 + g * 587 + b * 114) / 1000);
        }
        catch
        {
            // Return middle brightness as fallback
            return 128;
        }
    }
}