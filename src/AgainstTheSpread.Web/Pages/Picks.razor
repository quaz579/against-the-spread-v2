@page "/picks"
@using AgainstTheSpread.Core.Models
@using AgainstTheSpread.Web.Services
@using AgainstTheSpread.Web.Models
@using AgainstTheSpread.Web.Helpers

<PageTitle>Make Your Picks - Against The Spread</PageTitle>

<div class="container mt-4">
    <h1 class="mb-4">Make Your Weekly Picks</h1>

    @if (isLoading)
    {
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading games...</p>
        </div>
    }
    else if (gamesFromDb == null)
    {
        <!-- Error Message (if any) -->
        @if (errorMessage != null)
        {
            <div class="alert alert-warning" role="alert">
                <strong>Note:</strong> @errorMessage
            </div>
        }

        <!-- Auth Status Banner -->
        @if (AuthStateService.IsAuthenticated)
        {
            <div class="alert alert-success d-flex justify-content-between align-items-center mb-4">
                <span>Signed in as <strong>@AuthStateService.UserEmail</strong> - Your picks will be saved automatically!</span>
                <button class="btn btn-sm btn-outline-secondary" @onclick="Logout">Sign Out</button>
            </div>
        }
        else
        {
            <div class="alert alert-info mb-4">
                <strong>Sign in to save your picks!</strong> Without signing in, you'll download an Excel file to submit manually.
                <button class="btn btn-primary btn-sm ms-3" @onclick="Login">
                    Sign in with Google
                </button>
            </div>
        }

        <!-- Week Selection -->
        <div class="card mb-4">
            <div class="card-body">
                <h3 class="card-title">Select Week @(AuthStateService.IsAuthenticated ? "" : "and Enter Your Name")</h3>

                @if (!AuthStateService.IsAuthenticated)
                {
                    <div class="mb-3">
                        <label for="userName" class="form-label">Your Name</label>
                        <input type="text" class="form-control" id="userName" @bind="userName"
                            placeholder="Enter your full name" />
                    </div>
                }

                <div class="mb-3">
                    <label for="year" class="form-label">Season</label>
                    <select class="form-select" id="year" @bind="selectedYear" @bind:after="LoadAvailableWeeks">
                        <option value="2024">2024</option>
                        <option value="2025">2025</option>
                        <option value="2026">2026</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label for="week" class="form-label">Week</label>
                    <select class="form-select" id="week" @bind="selectedWeek" disabled="@(availableWeeks.Count == 0)">
                        <option value="0">-- Select Week --</option>
                        @foreach (var week in availableWeeks)
                        {
                            <option value="@week">Week @week</option>
                        }
                    </select>
                </div>

                <button class="btn btn-primary btn-lg" @onclick="LoadGames"
                    disabled="@((!AuthStateService.IsAuthenticated && string.IsNullOrWhiteSpace(userName)) || selectedWeek == 0)">
                    Continue to Picks
                </button>
            </div>
        </div>
    }
    else
    {
        <!-- Game Selection -->
        <div class="mb-3 d-flex justify-content-between align-items-center">
            <button class="btn btn-secondary" @onclick="GoBack">
                Back to Week Selection
            </button>

            @if (AuthStateService.IsAuthenticated)
            {
                <span class="badge bg-success">Signed in as @AuthStateService.UserEmail</span>
            }
        </div>

        <div class="alert alert-info" role="alert">
            @if (AuthStateService.IsAuthenticated)
            {
                <strong>Week @selectedWeek, @selectedYear</strong>
            }
            else
            {
                <text><strong>@userName</strong> - Week @selectedWeek, @selectedYear</text>
            }
            <br />
            <strong>Selected: @selectedPicks.Count / 6 picks</strong>
            @if (selectedPicks.Count == 6)
            {
                <span class="text-success ms-2">Ready to @(AuthStateService.IsAuthenticated ? "submit" : "download")!</span>
            }
        </div>

        @if (successMessage != null)
        {
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                @successMessage
                <button type="button" class="btn-close" @onclick="() => successMessage = null"></button>
            </div>
        }

        <div class="row">
            @foreach (var game in GetGamesForDisplay())
            {
                var isFavoriteSelected = selectedPicks.Contains(game.Favorite);
                var isUnderdogSelected = selectedPicks.Contains(game.Underdog);
                var gameDate = game.GameDate.ToString("ddd M/d h:mm tt");
                var favoriteColors = TeamColorService.GetTeamColors(game.Favorite);
                var underdogColors = TeamColorService.GetTeamColors(game.Underdog);
                var isLocked = game.IsLocked;

                <div class="col-md-6 col-lg-4 mb-3">
                    <div class="card h-100 @(isLocked ? "border-danger" : "")">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <small class="text-muted">@gameDate</small>
                                @if (isLocked)
                                {
                                    <span class="badge bg-danger">LOCKED</span>
                                }
                            </div>
                            <div class="d-grid gap-2">
                                <button class="btn @GetButtonClass(isFavoriteSelected, favoriteColors)"
                                    style="@GetButtonStyle(isFavoriteSelected, favoriteColors)"
                                    @onclick="() => TogglePick(game, game.Favorite)"
                                    disabled="@(isLocked || (!isFavoriteSelected && selectedPicks.Count >= 6))">
                                    <TeamLogo TeamName="@game.Favorite"
                                        Style="width: 20px; height: 20px; object-fit: contain; margin-right: 6px; vertical-align: middle;" />
                                    @game.Favorite @game.Line
                                    @if (isFavoriteSelected)
                                    {
                                        <span class="ms-1">&#10003;</span>
                                    }
                                </button>

                                <div class="text-center">
                                    <small class="text-muted">@game.VsAt</small>
                                </div>

                                <button class="btn @GetButtonClass(isUnderdogSelected, underdogColors)"
                                    style="@GetButtonStyle(isUnderdogSelected, underdogColors)"
                                    @onclick="() => TogglePick(game, game.Underdog)"
                                    disabled="@(isLocked || (!isUnderdogSelected && selectedPicks.Count >= 6))">
                                    <TeamLogo TeamName="@game.Underdog"
                                        Style="width: 20px; height: 20px; object-fit: contain; margin-right: 6px; vertical-align: middle;" />
                                    @game.Underdog
                                    @if (isUnderdogSelected)
                                    {
                                        <span class="ms-1">&#10003;</span>
                                    }
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>

        @if (selectedPicks.Count == 6)
        {
            <div class="fixed-bottom bg-white border-top p-3 shadow">
                <div class="container">
                    <div class="d-grid gap-2">
                        @if (AuthStateService.IsAuthenticated)
                        {
                            <button class="btn btn-success btn-lg" @onclick="SubmitPicksToDatabase" disabled="@isSubmitting">
                                @if (isSubmitting)
                                {
                                    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                    <span>Saving Picks...</span>
                                }
                                else
                                {
                                    <span>Save My Picks</span>
                                }
                            </button>
                        }
                        else
                        {
                            <button class="btn btn-success btn-lg" @onclick="GeneratePicks" disabled="@isDownloading">
                                @if (isDownloading)
                                {
                                    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                    <span>Generating Excel...</span>
                                }
                                else
                                {
                                    <span>Download Picks</span>
                                }
                            </button>
                            <button class="btn btn-outline-primary btn-lg" @onclick="PrintPicksSheet" disabled="@(isDownloading || isPrinting)">
                                @if (isPrinting)
                                {
                                    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                    <span>Opening Print View...</span>
                                }
                                else
                                {
                                    <span>Print My Picks</span>
                                }
                            </button>
                        }
                    </div>
                </div>
            </div>
        }
    }
</div>
