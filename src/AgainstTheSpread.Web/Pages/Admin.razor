@page "/admin"
@using AgainstTheSpread.Web.Services
@using Microsoft.AspNetCore.Components.Forms
@using System.Text.Json
@inject ApiService ApiService
@inject IJSRuntime JS
@inject HttpClient Http
@inject NavigationManager Navigation
@inject ILogger<Admin> Logger

<PageTitle>Admin - Upload Lines</PageTitle>

<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <h1 class="mb-4">üèà Admin - Upload Weekly Lines</h1>

            @if (!isAuthenticated)
            {
                <div class="card shadow-sm">
                    <div class="card-body text-center py-5">
                        <h3 class="mb-4">üîê Admin Access Required</h3>
                        <p class="text-muted mb-4">Please sign in with your Google account to access admin features.</p>
                        <button class="btn btn-primary btn-lg" @onclick="Login">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                class="bi bi-google me-2" viewBox="0 0 16 16">
                                <path
                                    d="M15.545 6.558a9.4 9.4 0 0 1 .139 1.626c0 2.434-.87 4.492-2.384 5.885h.002C11.978 15.292 10.158 16 8 16A8 8 0 1 1 8 0a7.7 7.7 0 0 1 5.352 2.082l-2.284 2.284A4.35 4.35 0 0 0 8 3.166c-2.087 0-3.86 1.408-4.492 3.304a4.8 4.8 0 0 0 0 3.063h.003c.635 1.893 2.405 3.301 4.492 3.301 1.078 0 2.004-.276 2.722-.764h-.003a3.7 3.7 0 0 0 1.599-2.431H8v-3.08z" />
                            </svg>
                            Sign in with Google
                        </button>
                    </div>
                </div>
            }
            else if (!isAuthorized)
            {
                <div class="alert alert-warning">
                    <h4>‚ö†Ô∏è Access Denied</h4>
                    <p>You are signed in as <strong>@userEmail</strong>, but you don't have admin privileges.</p>
                    <p>Please contact the site administrator if you believe this is an error.</p>
                    <button class="btn btn-secondary mt-2" @onclick="Logout">Sign Out</button>
                </div>
            }
            else
            {
                <div class="alert alert-info">
                    Signed in as: <strong>@userEmail</strong>
                    <button class="btn btn-sm btn-outline-secondary float-end" @onclick="Logout">Sign Out</button>
                </div>

                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        <strong>Error!</strong> @errorMessage
                        <button type="button" class="btn-close" @onclick="ClearError"></button>
                    </div>
                }

                @if (!string.IsNullOrEmpty(successMessage))
                {
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                        <strong>Success!</strong> @successMessage
                        <button type="button" class="btn-close" @onclick="ClearSuccess"></button>
                    </div>
                }

                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title">Upload Game Lines</h5>
                        <p class="text-muted">Upload an Excel file (.xlsx) containing the weekly betting lines.</p>

                        <div class="mb-3">
                            <label for="weekInput" class="form-label">Week Number</label>
                            <input type="number" class="form-control" id="weekInput" @bind="weekNumber" min="1" max="17"
                                placeholder="Enter week number (1-17)" />
                        </div>

                        <div class="mb-3">
                            <label for="yearInput" class="form-label">Year</label>
                            <input type="number" class="form-control" id="yearInput" @bind="year" min="2024" max="2030"
                                placeholder="Enter year" />
                        </div>

                        <div class="mb-3">
                            <label for="fileInput" class="form-label">Excel File</label>
                            <InputFile class="form-control" id="fileInput" OnChange="OnFileSelected"
                                accept=".xlsx,.xls,.csv" />
                            <div class="form-text">
                                Select an Excel file with game lines. Must include: Team, Opponent, Line, Date/Time.
                            </div>
                        </div>

                        @if (selectedFile != null)
                        {
                            <div class="alert alert-info">
                                <strong>Selected file:</strong> @selectedFile.Name (@(selectedFile.Size / 1024) KB)
                            </div>
                        }

                        <button class="btn btn-primary btn-lg w-100" @onclick="UploadFile"
                            disabled="@(isUploading || selectedFile == null || weekNumber < 1)">
                            @if (isUploading)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                <span>Uploading...</span>
                            }
                            else
                            {
                                <span>üì§ Upload Lines</span>
                            }
                        </button>
                    </div>
                </div>

                <div class="card shadow-sm mt-4">
                    <div class="card-body">
                        <h5 class="card-title">üìã File Format Requirements</h5>
                        <ul class="mb-0">
                            <li>Excel file (.xlsx or .xls) or CSV</li>
                            <li>Must contain columns: Team, Opponent, Line, Date/Time</li>
                            <li>Line format: "Team -7.5" or "Opponent +3.5"</li>
                            <li>Date format: "MM/DD/YYYY HH:MM" or similar</li>
                            <li>Each row represents one game</li>
                        </ul>
                    </div>
                </div>

                <div class="card shadow-sm mt-4">
                    <div class="card-body">
                        <h5 class="card-title">üí° Tips</h5>
                        <ul class="mb-0">
                            <li>Upload files on Sunday evening for the upcoming week</li>
                            <li>Double-check the week number before uploading</li>
                            <li>You can re-upload to overwrite existing lines</li>
                            <li>Users will see the new lines immediately after upload</li>
                        </ul>
                    </div>
                </div>

                <!-- Bowl Games Upload Section -->
                <hr class="my-5" />
                <h2 class="mb-4">üèÜ Bowl Games - Upload Bowl Lines</h2>

                @if (!string.IsNullOrEmpty(bowlErrorMessage))
                {
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        <strong>Error!</strong> @bowlErrorMessage
                        <button type="button" class="btn-close" @onclick="ClearBowlError"></button>
                    </div>
                }

                @if (!string.IsNullOrEmpty(bowlSuccessMessage))
                {
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                        <strong>Success!</strong> @bowlSuccessMessage
                        <button type="button" class="btn-close" @onclick="ClearBowlSuccess"></button>
                    </div>
                }

                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title">Upload Bowl Game Lines</h5>
                        <p class="text-muted">Upload an Excel file (.xlsx) containing the bowl game betting lines.</p>

                        <div class="mb-3">
                            <label for="bowlYearInput" class="form-label">Bowl Season Year</label>
                            <input type="number" class="form-control" id="bowlYearInput" @bind="bowlYear" min="2024" max="@(DateTime.Now.Year + 5)"
                                placeholder="Enter year" />
                        </div>

                        <div class="mb-3">
                            <label for="bowlFileInput" class="form-label">Bowl Lines Excel File</label>
                            <InputFile class="form-control" id="bowlFileInput" OnChange="OnBowlFileSelected"
                                accept=".xlsx,.xls" />
                            <div class="form-text">
                                Select an Excel file with bowl game lines. Must include: Bowl Name, Favorite, Line, Underdog, Date.
                            </div>
                        </div>

                        @if (selectedBowlFile != null)
                        {
                            <div class="alert alert-info">
                                <strong>Selected file:</strong> @selectedBowlFile.Name (@(selectedBowlFile.Size / 1024) KB)
                            </div>
                        }

                        <button class="btn btn-success btn-lg w-100" @onclick="UploadBowlFile"
                            disabled="@(isBowlUploading || selectedBowlFile == null)">
                            @if (isBowlUploading)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                <span>Uploading Bowl Lines...</span>
                            }
                            else
                            {
                                <span>üèÜ Upload Bowl Lines</span>
                            }
                        </button>
                    </div>
                </div>

                <div class="card shadow-sm mt-4">
                    <div class="card-body">
                        <h5 class="card-title">üìã Bowl File Format Requirements</h5>
                        <ul class="mb-0">
                            <li>Excel file (.xlsx)</li>
                            <li>Must contain columns: Bowl Name, Favorite, Line, Underdog (Under Dog), Date</li>
                            <li>Line format: -7.5 or +3.5 (numeric values)</li>
                            <li>Date format: MM/DD/YYYY or similar</li>
                            <li>Each row represents one bowl game</li>
                        </ul>
                    </div>
                </div>

                <!-- Results Entry Section -->
                <hr class="my-5" />
                <h2 class="mb-4">üìä Enter Game Results</h2>

                @if (!string.IsNullOrEmpty(resultsErrorMessage))
                {
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        <strong>Error!</strong> @resultsErrorMessage
                        <button type="button" class="btn-close" @onclick="ClearResultsError"></button>
                    </div>
                }

                @if (!string.IsNullOrEmpty(resultsSuccessMessage))
                {
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                        <strong>Success!</strong> @resultsSuccessMessage
                        <button type="button" class="btn-close" @onclick="ClearResultsSuccess"></button>
                    </div>
                }

                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title">Enter Final Scores</h5>
                        <p class="text-muted">Enter the final scores for games after they have been played.</p>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="resultsWeek" class="form-label">Week</label>
                                <select class="form-select" id="resultsWeek" @bind="resultsWeek">
                                    @for (int i = 1; i <= 17; i++)
                                    {
                                        <option value="@i">Week @i</option>
                                    }
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="resultsYear" class="form-label">Year</label>
                                <input type="number" class="form-control" id="resultsYear" @bind="resultsYear" min="2024" max="2030" />
                            </div>
                        </div>

                        <button class="btn btn-outline-primary mb-3" @onclick="LoadGamesForResults" disabled="@isLoadingGames">
                            @if (isLoadingGames)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                <span>Loading...</span>
                            }
                            else
                            {
                                <span>Load Games</span>
                            }
                        </button>

                        @if (gamesForResults != null && gamesForResults.Any())
                        {
                            <div class="table-responsive">
                                <table class="table table-sm table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Matchup</th>
                                            <th>Line</th>
                                            <th style="width: 80px;">Fav</th>
                                            <th style="width: 80px;">Dog</th>
                                            <th>Result</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var game in gamesForResults)
                                        {
                                            var scores = gameScores.GetValueOrDefault(game.Id, new ScoreEntry());
                                            <tr class="@(game.HasResult ? "table-success" : game.IsLocked ? "" : "table-warning")">
                                                <td>
                                                    <strong>@game.Favorite</strong> vs @game.Underdog
                                                    <br />
                                                    <small class="text-muted">@game.GameDate.ToString("ddd M/d h:mm tt")</small>
                                                </td>
                                                <td>@game.Line</td>
                                                <td>
                                                    <input type="number" class="form-control form-control-sm"
                                                        value="@scores.FavoriteScore"
                                                        @onchange="@(e => UpdateFavoriteScore(game.Id, e.Value?.ToString()))"
                                                        min="0" disabled="@(!game.IsLocked)" />
                                                </td>
                                                <td>
                                                    <input type="number" class="form-control form-control-sm"
                                                        value="@scores.UnderdogScore"
                                                        @onchange="@(e => UpdateUnderdogScore(game.Id, e.Value?.ToString()))"
                                                        min="0" disabled="@(!game.IsLocked)" />
                                                </td>
                                                <td>
                                                    @if (game.HasResult)
                                                    {
                                                        @if (game.IsPush == true)
                                                        {
                                                            <span class="badge bg-secondary">PUSH</span>
                                                        }
                                                        else
                                                        {
                                                            <span class="badge bg-success">@game.SpreadWinner</span>
                                                        }
                                                    }
                                                    else if (!game.IsLocked)
                                                    {
                                                        <small class="text-warning">Not started</small>
                                                    }
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>

                            <div class="d-flex justify-content-between align-items-center mt-3">
                                <small class="text-muted">
                                    @gamesForResults.Count(g => g.HasResult) of @gamesForResults.Count games have results
                                </small>
                                <button class="btn btn-success btn-lg" @onclick="SubmitResults" disabled="@isSubmittingResults">
                                    @if (isSubmittingResults)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                        <span>Saving...</span>
                                    }
                                    else
                                    {
                                        <span>Save Results</span>
                                    }
                                </button>
                            </div>
                        }
                        else if (gamesForResults != null)
                        {
                            <div class="alert alert-info">
                                No games found for Week @resultsWeek, @resultsYear. Make sure lines have been uploaded first.
                            </div>
                        }
                    </div>
                </div>

                <!-- CFBD API Sync Section -->
                <hr class="my-5" />
                <h2 class="mb-4">üîÑ Sync from CFBD API</h2>

                @if (!string.IsNullOrEmpty(syncErrorMessage))
                {
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        <strong>Error!</strong> @syncErrorMessage
                        <button type="button" class="btn-close" @onclick="ClearSyncError"></button>
                    </div>
                }

                @if (!string.IsNullOrEmpty(syncSuccessMessage))
                {
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                        <strong>Success!</strong> @syncSuccessMessage
                        <button type="button" class="btn-close" @onclick="ClearSyncSuccess"></button>
                    </div>
                }

                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <h5 class="card-title">API Status</h5>
                        <p class="text-muted">Check if the College Football Data API is configured.</p>

                        @if (syncStatus == null)
                        {
                            <button class="btn btn-outline-secondary" @onclick="CheckSyncStatus" disabled="@isCheckingStatus">
                                @if (isCheckingStatus)
                                {
                                    <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                    <span>Checking...</span>
                                }
                                else
                                {
                                    <span>Check API Status</span>
                                }
                            </button>
                        }
                        else
                        {
                            <div class="alert @(syncStatus.IsConfigured ? "alert-success" : "alert-warning") mb-0">
                                <strong>Provider:</strong> @syncStatus.Provider<br />
                                <strong>Status:</strong> @(syncStatus.IsConfigured ? "Configured ‚úì" : "Not Configured")<br />
                                <small class="text-muted">@syncStatus.Message</small>
                            </div>
                        }
                    </div>
                </div>

                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="card shadow-sm h-100">
                            <div class="card-body">
                                <h5 class="card-title">Sync Weekly Games</h5>
                                <p class="text-muted">Pull weekly game lines and spreads from CFBD.</p>

                                <div class="row mb-3">
                                    <div class="col-6">
                                        <label for="syncWeek" class="form-label">Week</label>
                                        <select class="form-select" id="syncWeek" @bind="syncWeek">
                                            @for (int i = 1; i <= 17; i++)
                                            {
                                                <option value="@i">Week @i</option>
                                            }
                                        </select>
                                    </div>
                                    <div class="col-6">
                                        <label for="syncYear" class="form-label">Year</label>
                                        <input type="number" class="form-control" id="syncYear" @bind="syncYear" min="2020" max="2030" />
                                    </div>
                                </div>

                                <button class="btn btn-primary w-100" @onclick="SyncWeeklyGames" disabled="@isSyncingWeekly">
                                    @if (isSyncingWeekly)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                        <span>Syncing...</span>
                                    }
                                    else
                                    {
                                        <span>üîÑ Sync Week @syncWeek</span>
                                    }
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="card shadow-sm h-100">
                            <div class="card-body">
                                <h5 class="card-title">Sync Weekly Results</h5>
                                <p class="text-muted">Pull final scores from completed games.</p>

                                <div class="row mb-3">
                                    <div class="col-6">
                                        <label for="syncResultsWeek" class="form-label">Week</label>
                                        <select class="form-select" id="syncResultsWeek" @bind="syncResultsWeek">
                                            @for (int i = 1; i <= 17; i++)
                                            {
                                                <option value="@i">Week @i</option>
                                            }
                                        </select>
                                    </div>
                                    <div class="col-6">
                                        <label for="syncResultsYear" class="form-label">Year</label>
                                        <input type="number" class="form-control" id="syncResultsYear" @bind="syncResultsYear" min="2020" max="2030" />
                                    </div>
                                </div>

                                <button class="btn btn-info w-100 text-white" @onclick="SyncWeeklyResults" disabled="@isSyncingResults">
                                    @if (isSyncingResults)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                        <span>Syncing...</span>
                                    }
                                    else
                                    {
                                        <span>üìä Sync Results</span>
                                    }
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="card shadow-sm h-100">
                            <div class="card-body">
                                <h5 class="card-title">Sync Bowl Games</h5>
                                <p class="text-muted">Pull bowl game lines and spreads from CFBD.</p>

                                <div class="mb-3">
                                    <label for="syncBowlYear" class="form-label">Bowl Season Year</label>
                                    <input type="number" class="form-control" id="syncBowlYear" @bind="syncBowlYear" min="2020" max="2030" />
                                </div>

                                <button class="btn btn-success w-100" @onclick="SyncBowlGames" disabled="@isSyncingBowl">
                                    @if (isSyncingBowl)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                        <span>Syncing...</span>
                                    }
                                    else
                                    {
                                        <span>üèÜ Sync Bowl Games</span>
                                    }
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card shadow-sm mt-4">
                    <div class="card-body">
                        <h5 class="card-title">üí° About CFBD Sync</h5>
                        <ul class="mb-0">
                            <li>Data is pulled from the <a href="https://collegefootballdata.com" target="_blank">College Football Data API</a></li>
                            <li>Spreads are automatically converted (positive line on home team = away team is favorite)</li>
                            <li>Existing games with matching teams are updated; new games are created</li>
                            <li>Requires <code>CFBD_API_KEY</code> environment variable to be configured</li>
                            <li>Free tier allows 1,000 requests/month</li>
                        </ul>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@code {
    private bool isAuthenticated = false;
    private bool isAuthorized = false;
    private string? userEmail;
    private int weekNumber = 1;
    private int year = DateTime.Now.Year;
    private IBrowserFile? selectedFile;
    private bool isUploading = false;
    private string? errorMessage;
    private string? successMessage;

    // Bowl upload fields
    private int bowlYear = DateTime.Now.Year;
    private IBrowserFile? selectedBowlFile;
    private bool isBowlUploading = false;
    private string? bowlErrorMessage;
    private string? bowlSuccessMessage;

    // Results entry fields
    private int resultsWeek = 1;
    private int resultsYear = DateTime.Now.Year;
    private bool isLoadingGames = false;
    private bool isSubmittingResults = false;
    private string? resultsErrorMessage;
    private string? resultsSuccessMessage;
    private List<ApiService.GameResultDto>? gamesForResults;
    private Dictionary<int, ScoreEntry> gameScores = new();

    // CFBD Sync fields
    private int syncWeek = 1;
    private int syncYear = DateTime.Now.Year;
    private int syncBowlYear = DateTime.Now.Year;
    private int syncResultsWeek = 1;
    private int syncResultsYear = DateTime.Now.Year;
    private bool isCheckingStatus = false;
    private bool isSyncingWeekly = false;
    private bool isSyncingBowl = false;
    private bool isSyncingResults = false;
    private string? syncErrorMessage;
    private string? syncSuccessMessage;
    private ApiService.SyncStatusResponse? syncStatus;

    protected override async Task OnInitializedAsync()
    {
        await CheckAuthStatus();
    }

    private async Task CheckAuthStatus()
    {
        try
        {
            // Create a new HttpClient with the host base address for auth endpoints
            using var authClient = new HttpClient { BaseAddress = new Uri(Navigation.BaseUri) };

            var response = await authClient.GetAsync(".auth/me");
            if (response.IsSuccessStatusCode)
            {
                var json = await response.Content.ReadAsStringAsync();
                Logger.LogDebug("Auth response: {AuthResponse}", json);

                var authInfo = JsonSerializer.Deserialize<AuthMeResponse>(json, new JsonSerializerOptions
                {
                    PropertyNameCaseInsensitive = true
                });

                if (authInfo?.ClientPrincipal != null)
                {
                    isAuthenticated = true;
                    userEmail = authInfo.ClientPrincipal.UserDetails;

                    // For now, assume authenticated users are authorized
                    // The backend will do the actual email validation
                    isAuthorized = true;
                }
                else
                {
                    Logger.LogWarning("No client principal in auth response");
                }
            }
            else
            {
                Logger.LogWarning("Auth check failed with status code: {StatusCode}", response.StatusCode);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error checking authentication status");
        }
    }

    private void Login()
    {
        // Use absolute URL for redirect to ensure it works in staging environments
        var redirectUri = new Uri(new Uri(Navigation.BaseUri), "/admin").ToString();
        Navigation.NavigateTo($"/.auth/login/google?post_login_redirect_uri={Uri.EscapeDataString(redirectUri)}", true);
    }

    private void Logout()
    {
        // Use absolute URL for redirect to ensure it works in staging environments
        var redirectUri = new Uri(new Uri(Navigation.BaseUri), "/").ToString();
        Navigation.NavigateTo($"/.auth/logout?post_logout_redirect_uri={Uri.EscapeDataString(redirectUri)}", true);
    }

    private void OnFileSelected(InputFileChangeEventArgs e)
    {
        selectedFile = e.File;
        ClearMessages();
    }

    private async Task UploadFile()
    {
        if (selectedFile == null || weekNumber < 1)
            return;

        isUploading = true;
        ClearMessages();

        try
        {
            // Read file stream
            using var stream = selectedFile.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024); // 10 MB limit
            using var memoryStream = new MemoryStream();
            await stream.CopyToAsync(memoryStream);
            memoryStream.Position = 0;

            // Upload to API
            var response = await ApiService.UploadLinesAsync(weekNumber, year, memoryStream, selectedFile.Name);

            if (response?.Success == true)
            {
                successMessage = response.Message;
                selectedFile = null;
            }
            else
            {
                errorMessage = "Failed to upload file. Please check the format and try again.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error uploading file: {ex.Message}";
        }
        finally
        {
            isUploading = false;
        }
    }

    private void ClearMessages()
    {
        errorMessage = null;
        successMessage = null;
    }

    private void ClearError()
    {
        errorMessage = null;
    }

    private void ClearSuccess()
    {
        successMessage = null;
    }

    // Bowl upload methods
    private void OnBowlFileSelected(InputFileChangeEventArgs e)
    {
        selectedBowlFile = e.File;
        ClearBowlMessages();
    }

    private async Task UploadBowlFile()
    {
        if (selectedBowlFile == null)
            return;

        isBowlUploading = true;
        ClearBowlMessages();

        try
        {
            // Read file stream
            using var stream = selectedBowlFile.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024); // 10 MB limit
            using var memoryStream = new MemoryStream();
            await stream.CopyToAsync(memoryStream);
            memoryStream.Position = 0;

            // Upload to API
            var response = await ApiService.UploadBowlLinesAsync(bowlYear, memoryStream, selectedBowlFile.Name);

            if (response?.Success == true)
            {
                bowlSuccessMessage = response.Message;
                selectedBowlFile = null;
            }
            else
            {
                bowlErrorMessage = "Failed to upload bowl file. Please check the format and try again.";
            }
        }
        catch (Exception ex)
        {
            bowlErrorMessage = $"Error uploading bowl file: {ex.Message}";
        }
        finally
        {
            isBowlUploading = false;
        }
    }

    private void ClearBowlMessages()
    {
        bowlErrorMessage = null;
        bowlSuccessMessage = null;
    }

    private void ClearBowlError()
    {
        bowlErrorMessage = null;
    }

    private void ClearBowlSuccess()
    {
        bowlSuccessMessage = null;
    }

    // Helper classes for SWA auth
    private class AuthMeResponse
    {
        public ClientPrincipal? ClientPrincipal { get; set; }
    }

    private class ClientPrincipal
    {
        public string? IdentityProvider { get; set; }
        public string? UserId { get; set; }
        public string? UserDetails { get; set; }
        public List<string>? UserRoles { get; set; }
    }

    // Results entry methods
    private async Task LoadGamesForResults()
    {
        isLoadingGames = true;
        ClearResultsMessages();

        try
        {
            var response = await ApiService.GetResultsAsync(resultsWeek, resultsYear);
            if (response != null)
            {
                gamesForResults = response.Games;

                // Initialize score entries for games that already have results
                gameScores.Clear();
                foreach (var game in response.Games)
                {
                    gameScores[game.Id] = new ScoreEntry
                    {
                        FavoriteScore = game.FavoriteScore,
                        UnderdogScore = game.UnderdogScore
                    };
                }
            }
            else
            {
                gamesForResults = new List<ApiService.GameResultDto>();
            }
        }
        catch (Exception ex)
        {
            resultsErrorMessage = $"Error loading games: {ex.Message}";
        }
        finally
        {
            isLoadingGames = false;
        }
    }

    private void UpdateFavoriteScore(int gameId, string? value)
    {
        if (!gameScores.ContainsKey(gameId))
        {
            gameScores[gameId] = new ScoreEntry();
        }

        if (int.TryParse(value, out int score))
        {
            gameScores[gameId].FavoriteScore = score;
        }
        else
        {
            gameScores[gameId].FavoriteScore = null;
        }
    }

    private void UpdateUnderdogScore(int gameId, string? value)
    {
        if (!gameScores.ContainsKey(gameId))
        {
            gameScores[gameId] = new ScoreEntry();
        }

        if (int.TryParse(value, out int score))
        {
            gameScores[gameId].UnderdogScore = score;
        }
        else
        {
            gameScores[gameId].UnderdogScore = null;
        }
    }

    private async Task SubmitResults()
    {
        isSubmittingResults = true;
        ClearResultsMessages();

        try
        {
            // Only submit games that have both scores entered
            var resultsToSubmit = gameScores
                .Where(kvp => kvp.Value.FavoriteScore.HasValue && kvp.Value.UnderdogScore.HasValue)
                .Select(kvp => new ApiService.ResultInput
                {
                    GameId = kvp.Key,
                    FavoriteScore = kvp.Value.FavoriteScore!.Value,
                    UnderdogScore = kvp.Value.UnderdogScore!.Value
                })
                .ToList();

            if (!resultsToSubmit.Any())
            {
                resultsErrorMessage = "No complete scores to submit. Enter both scores for at least one game.";
                return;
            }

            var response = await ApiService.SubmitResultsAsync(resultsWeek, resultsYear, resultsToSubmit);

            if (response?.Success == true)
            {
                resultsSuccessMessage = $"Successfully saved {response.ResultsEntered} result(s)!";
                // Reload games to show updated results
                await LoadGamesForResults();
            }
            else
            {
                resultsErrorMessage = response?.Message ?? "Failed to submit results. Please try again.";
            }
        }
        catch (Exception ex)
        {
            resultsErrorMessage = $"Error submitting results: {ex.Message}";
        }
        finally
        {
            isSubmittingResults = false;
        }
    }

    private void ClearResultsMessages()
    {
        resultsErrorMessage = null;
        resultsSuccessMessage = null;
    }

    private void ClearResultsError()
    {
        resultsErrorMessage = null;
    }

    private void ClearResultsSuccess()
    {
        resultsSuccessMessage = null;
    }

    // Helper class for score entry
    private class ScoreEntry
    {
        public int? FavoriteScore { get; set; }
        public int? UnderdogScore { get; set; }
    }

    // CFBD Sync methods
    private async Task CheckSyncStatus()
    {
        isCheckingStatus = true;
        ClearSyncMessages();

        try
        {
            syncStatus = await ApiService.GetSyncStatusAsync();
            if (syncStatus == null)
            {
                syncErrorMessage = "Failed to check API status. Please try again.";
            }
        }
        catch (Exception ex)
        {
            syncErrorMessage = $"Error checking status: {ex.Message}";
        }
        finally
        {
            isCheckingStatus = false;
        }
    }

    private async Task SyncWeeklyGames()
    {
        isSyncingWeekly = true;
        ClearSyncMessages();

        try
        {
            var response = await ApiService.SyncWeeklyGamesAsync(syncWeek, syncYear);

            if (response?.Success == true)
            {
                syncSuccessMessage = $"Synced {response.GamesSynced} games for Week {syncWeek}, {syncYear} from {response.Provider}";
            }
            else
            {
                syncErrorMessage = response?.Message ?? "Failed to sync weekly games. Please try again.";
            }
        }
        catch (Exception ex)
        {
            syncErrorMessage = $"Error syncing weekly games: {ex.Message}";
        }
        finally
        {
            isSyncingWeekly = false;
        }
    }

    private async Task SyncBowlGames()
    {
        isSyncingBowl = true;
        ClearSyncMessages();

        try
        {
            var response = await ApiService.SyncBowlGamesAsync(syncBowlYear);

            if (response?.Success == true)
            {
                syncSuccessMessage = $"Synced {response.GamesSynced} bowl games for {syncBowlYear} from {response.Provider}";
            }
            else
            {
                syncErrorMessage = response?.Message ?? "Failed to sync bowl games. Please try again.";
            }
        }
        catch (Exception ex)
        {
            syncErrorMessage = $"Error syncing bowl games: {ex.Message}";
        }
        finally
        {
            isSyncingBowl = false;
        }
    }

    private async Task SyncWeeklyResults()
    {
        isSyncingResults = true;
        ClearSyncMessages();

        try
        {
            var response = await ApiService.SyncWeeklyResultsAsync(syncResultsWeek, syncResultsYear);

            if (response?.Success == true)
            {
                var message = $"Synced {response.ResultsSynced} results for Week {syncResultsWeek}, {syncResultsYear}";
                if (response.GamesSkipped > 0)
                {
                    message += $" ({response.GamesSkipped} games already had results)";
                }
                if (response.GamesNotFound > 0)
                {
                    message += $" ({response.GamesNotFound} games not found in database)";
                }
                syncSuccessMessage = message;

                // Reload the games if we're viewing the same week
                if (syncResultsWeek == resultsWeek && syncResultsYear == resultsYear && gamesForResults != null)
                {
                    await LoadGamesForResults();
                }
            }
            else
            {
                syncErrorMessage = response?.Message ?? "Failed to sync results. Please try again.";
            }
        }
        catch (Exception ex)
        {
            syncErrorMessage = $"Error syncing results: {ex.Message}";
        }
        finally
        {
            isSyncingResults = false;
        }
    }

    private void ClearSyncMessages()
    {
        syncErrorMessage = null;
        syncSuccessMessage = null;
    }

    private void ClearSyncError()
    {
        syncErrorMessage = null;
    }

    private void ClearSyncSuccess()
    {
        syncSuccessMessage = null;
    }
}