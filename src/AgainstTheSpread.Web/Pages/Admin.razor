@page "/admin"
@using AgainstTheSpread.Web.Services
@using Microsoft.AspNetCore.Components.Forms

<PageTitle>Admin - Upload Lines</PageTitle>

<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <h1 class="mb-4">üèà Admin - Upload Weekly Lines</h1>

            @if (!isAuthenticated)
            {
                <div class="card shadow-sm">
                    <div class="card-body text-center py-5">
                        <h3 class="mb-4">üîê Admin Access Required</h3>
                        <p class="text-muted mb-4">Please sign in with your Google account to access admin features.</p>
                        <button class="btn btn-primary btn-lg" @onclick="Login">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                class="bi bi-google me-2" viewBox="0 0 16 16">
                                <path
                                    d="M15.545 6.558a9.4 9.4 0 0 1 .139 1.626c0 2.434-.87 4.492-2.384 5.885h.002C11.978 15.292 10.158 16 8 16A8 8 0 1 1 8 0a7.7 7.7 0 0 1 5.352 2.082l-2.284 2.284A4.35 4.35 0 0 0 8 3.166c-2.087 0-3.86 1.408-4.492 3.304a4.8 4.8 0 0 0 0 3.063h.003c.635 1.893 2.405 3.301 4.492 3.301 1.078 0 2.004-.276 2.722-.764h-.003a3.7 3.7 0 0 0 1.599-2.431H8v-3.08z" />
                            </svg>
                            Sign in with Google
                        </button>
                    </div>
                </div>
            }
            else if (!isAuthorized)
            {
                <div class="alert alert-warning">
                    <h4>‚ö†Ô∏è Access Denied</h4>
                    <p>You are signed in as <strong>@userEmail</strong>, but you don't have admin privileges.</p>
                    <p>Please contact the site administrator if you believe this is an error.</p>
                    <button class="btn btn-secondary mt-2" @onclick="Logout">Sign Out</button>
                </div>
            }
            else
            {
                <div class="alert alert-info">
                    Signed in as: <strong>@userEmail</strong>
                    <button class="btn btn-sm btn-outline-secondary float-end" @onclick="Logout">Sign Out</button>
                </div>

                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        <strong>Error!</strong> @errorMessage
                        <button type="button" class="btn-close" @onclick="ClearError"></button>
                    </div>
                }

                @if (!string.IsNullOrEmpty(successMessage))
                {
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                        <strong>Success!</strong> @successMessage
                        <button type="button" class="btn-close" @onclick="ClearSuccess"></button>
                    </div>
                }

                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title">Upload Game Lines</h5>
                        <p class="text-muted">Upload an Excel file (.xlsx) containing the weekly betting lines.</p>

                        <div class="mb-3">
                            <label for="weekInput" class="form-label">Week Number</label>
                            <input type="number" class="form-control" id="weekInput" @bind="weekNumber" min="1" max="17"
                                placeholder="Enter week number (1-17)" />
                        </div>

                        <div class="mb-3">
                            <label for="yearInput" class="form-label">Year</label>
                            <input type="number" class="form-control" id="yearInput" @bind="year" min="2024" max="2030"
                                placeholder="Enter year" />
                        </div>

                        <div class="mb-3">
                            <label for="fileInput" class="form-label">Excel File</label>
                            <InputFile class="form-control" id="fileInput" OnChange="OnFileSelected"
                                accept=".xlsx,.xls,.csv" />
                            <div class="form-text">
                                Select an Excel file with game lines. Must include: Team, Opponent, Line, Date/Time.
                            </div>
                        </div>

                        @if (selectedFile != null)
                        {
                            <div class="alert alert-info">
                                <strong>Selected file:</strong> @selectedFile.Name (@(selectedFile.Size / 1024) KB)
                            </div>
                        }

                        <button class="btn btn-primary btn-lg w-100" @onclick="UploadFile"
                            disabled="@(isUploading || selectedFile == null || weekNumber < 1)">
                            @if (isUploading)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                <span>Uploading...</span>
                            }
                            else
                            {
                                <span>üì§ Upload Lines</span>
                            }
                        </button>
                    </div>
                </div>

                <div class="card shadow-sm mt-4">
                    <div class="card-body">
                        <h5 class="card-title">üìã File Format Requirements</h5>
                        <ul class="mb-0">
                            <li>Excel file (.xlsx or .xls) or CSV</li>
                            <li>Must contain columns: Team, Opponent, Line, Date/Time</li>
                            <li>Line format: "Team -7.5" or "Opponent +3.5"</li>
                            <li>Date format: "MM/DD/YYYY HH:MM" or similar</li>
                            <li>Each row represents one game</li>
                        </ul>
                    </div>
                </div>

                <div class="card shadow-sm mt-4">
                    <div class="card-body">
                        <h5 class="card-title">üí° Tips</h5>
                        <ul class="mb-0">
                            <li>Upload files on Sunday evening for the upcoming week</li>
                            <li>Double-check the week number before uploading</li>
                            <li>You can re-upload to overwrite existing lines</li>
                            <li>Users will see the new lines immediately after upload</li>
                        </ul>
                    </div>
                </div>

                <!-- Bowl Games Upload Section -->
                <hr class="my-5" />
                <h2 class="mb-4">üèÜ Bowl Games - Upload Bowl Lines</h2>

                @if (!string.IsNullOrEmpty(bowlErrorMessage))
                {
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        <strong>Error!</strong> @bowlErrorMessage
                        <button type="button" class="btn-close" @onclick="ClearBowlError"></button>
                    </div>
                }

                @if (!string.IsNullOrEmpty(bowlSuccessMessage))
                {
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                        <strong>Success!</strong> @bowlSuccessMessage
                        <button type="button" class="btn-close" @onclick="ClearBowlSuccess"></button>
                    </div>
                }

                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title">Upload Bowl Game Lines</h5>
                        <p class="text-muted">Upload an Excel file (.xlsx) containing the bowl game betting lines.</p>

                        <div class="mb-3">
                            <label for="bowlYearInput" class="form-label">Bowl Season Year</label>
                            <input type="number" class="form-control" id="bowlYearInput" @bind="bowlYear" min="2024" max="@(DateTime.Now.Year + 5)"
                                placeholder="Enter year" />
                        </div>

                        <div class="mb-3">
                            <label for="bowlFileInput" class="form-label">Bowl Lines Excel File</label>
                            <InputFile class="form-control" id="bowlFileInput" OnChange="OnBowlFileSelected"
                                accept=".xlsx,.xls" />
                            <div class="form-text">
                                Select an Excel file with bowl game lines. Must include: Bowl Name, Favorite, Line, Underdog, Date.
                            </div>
                        </div>

                        @if (selectedBowlFile != null)
                        {
                            <div class="alert alert-info">
                                <strong>Selected file:</strong> @selectedBowlFile.Name (@(selectedBowlFile.Size / 1024) KB)
                            </div>
                        }

                        <button class="btn btn-success btn-lg w-100" @onclick="UploadBowlFile"
                            disabled="@(isBowlUploading || selectedBowlFile == null)">
                            @if (isBowlUploading)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                <span>Uploading Bowl Lines...</span>
                            }
                            else
                            {
                                <span>üèÜ Upload Bowl Lines</span>
                            }
                        </button>
                    </div>
                </div>

                <div class="card shadow-sm mt-4">
                    <div class="card-body">
                        <h5 class="card-title">üìã Bowl File Format Requirements</h5>
                        <ul class="mb-0">
                            <li>Excel file (.xlsx)</li>
                            <li>Must contain columns: Bowl Name, Favorite, Line, Underdog (Under Dog), Date</li>
                            <li>Line format: -7.5 or +3.5 (numeric values)</li>
                            <li>Date format: MM/DD/YYYY or similar</li>
                            <li>Each row represents one bowl game</li>
                        </ul>
                    </div>
                </div>

                <!-- Results Entry Section -->
                <hr class="my-5" />
                <h2 class="mb-4">üìä Enter Game Results</h2>

                @if (!string.IsNullOrEmpty(resultsErrorMessage))
                {
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        <strong>Error!</strong> @resultsErrorMessage
                        <button type="button" class="btn-close" @onclick="ClearResultsError"></button>
                    </div>
                }

                @if (!string.IsNullOrEmpty(resultsSuccessMessage))
                {
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                        <strong>Success!</strong> @resultsSuccessMessage
                        <button type="button" class="btn-close" @onclick="ClearResultsSuccess"></button>
                    </div>
                }

                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title">Enter Final Scores</h5>
                        <p class="text-muted">Enter the final scores for games after they have been played.</p>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="resultsWeek" class="form-label">Week</label>
                                <select class="form-select" id="resultsWeek" @bind="resultsWeek">
                                    @for (int i = 1; i <= 17; i++)
                                    {
                                        <option value="@i">Week @i</option>
                                    }
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="resultsYear" class="form-label">Year</label>
                                <input type="number" class="form-control" id="resultsYear" @bind="resultsYear" min="2024" max="2030" />
                            </div>
                        </div>

                        <button class="btn btn-outline-primary mb-3" @onclick="LoadGamesForResults" disabled="@isLoadingGames">
                            @if (isLoadingGames)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                <span>Loading...</span>
                            }
                            else
                            {
                                <span>Load Games</span>
                            }
                        </button>

                        @if (gamesForResults != null && gamesForResults.Any())
                        {
                            <div class="table-responsive">
                                <table class="table table-sm table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Matchup</th>
                                            <th>Line</th>
                                            <th style="width: 80px;">Fav</th>
                                            <th style="width: 80px;">Dog</th>
                                            <th>Result</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var game in gamesForResults)
                                        {
                                            var scores = gameScores.GetValueOrDefault(game.Id, new ScoreEntry());
                                            <tr class="@(game.HasResult ? "table-success" : game.IsLocked ? "" : "table-warning")">
                                                <td>
                                                    <strong>@game.Favorite</strong> vs @game.Underdog
                                                    <br />
                                                    <small class="text-muted">@game.GameDate.ToString("ddd M/d h:mm tt")</small>
                                                </td>
                                                <td>@game.Line</td>
                                                <td>
                                                    <input type="number" class="form-control form-control-sm"
                                                        value="@scores.FavoriteScore"
                                                        @onchange="@(e => UpdateFavoriteScore(game.Id, e.Value?.ToString()))"
                                                        min="0" disabled="@(!game.IsLocked)" />
                                                </td>
                                                <td>
                                                    <input type="number" class="form-control form-control-sm"
                                                        value="@scores.UnderdogScore"
                                                        @onchange="@(e => UpdateUnderdogScore(game.Id, e.Value?.ToString()))"
                                                        min="0" disabled="@(!game.IsLocked)" />
                                                </td>
                                                <td>
                                                    @if (game.HasResult)
                                                    {
                                                        @if (game.IsPush == true)
                                                        {
                                                            <span class="badge bg-secondary">PUSH</span>
                                                        }
                                                        else
                                                        {
                                                            <span class="badge bg-success">@game.SpreadWinner</span>
                                                        }
                                                    }
                                                    else if (!game.IsLocked)
                                                    {
                                                        <small class="text-warning">Not started</small>
                                                    }
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>

                            <div class="d-flex justify-content-between align-items-center mt-3">
                                <small class="text-muted">
                                    @gamesForResults.Count(g => g.HasResult) of @gamesForResults.Count games have results
                                </small>
                                <button class="btn btn-success btn-lg" @onclick="SubmitResults" disabled="@isSubmittingResults">
                                    @if (isSubmittingResults)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                        <span>Saving...</span>
                                    }
                                    else
                                    {
                                        <span>Save Results</span>
                                    }
                                </button>
                            </div>
                        }
                        else if (gamesForResults != null)
                        {
                            <div class="alert alert-info">
                                No games found for Week @resultsWeek, @resultsYear. Make sure lines have been uploaded first.
                            </div>
                        }
                    </div>
                </div>

                <!-- CFBD API Sync Section -->
                <hr class="my-5" />
                <h2 class="mb-4">üîÑ Sync from CFBD API</h2>

                @if (!string.IsNullOrEmpty(syncErrorMessage))
                {
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        <strong>Error!</strong> @syncErrorMessage
                        <button type="button" class="btn-close" @onclick="ClearSyncError"></button>
                    </div>
                }

                @if (!string.IsNullOrEmpty(syncSuccessMessage))
                {
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                        <strong>Success!</strong> @syncSuccessMessage
                        <button type="button" class="btn-close" @onclick="ClearSyncSuccess"></button>
                    </div>
                }

                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <h5 class="card-title">API Status</h5>
                        <p class="text-muted">Check if the College Football Data API is configured.</p>

                        @if (syncStatus == null)
                        {
                            <button class="btn btn-outline-secondary" @onclick="CheckSyncStatus" disabled="@isCheckingStatus">
                                @if (isCheckingStatus)
                                {
                                    <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                    <span>Checking...</span>
                                }
                                else
                                {
                                    <span>Check API Status</span>
                                }
                            </button>
                        }
                        else
                        {
                            <div class="alert @(syncStatus.IsConfigured ? "alert-success" : "alert-warning") mb-0">
                                <strong>Provider:</strong> @syncStatus.Provider<br />
                                <strong>Status:</strong> @(syncStatus.IsConfigured ? "Configured ‚úì" : "Not Configured")<br />
                                <small class="text-muted">@syncStatus.Message</small>
                            </div>
                        }
                    </div>
                </div>

                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="card shadow-sm h-100">
                            <div class="card-body">
                                <h5 class="card-title">Sync Weekly Games</h5>
                                <p class="text-muted">Pull weekly game lines and spreads from CFBD.</p>

                                <div class="row mb-3">
                                    <div class="col-6">
                                        <label for="syncWeek" class="form-label">Week</label>
                                        <select class="form-select" id="syncWeek" @bind="syncWeek">
                                            @for (int i = 1; i <= 17; i++)
                                            {
                                                <option value="@i">Week @i</option>
                                            }
                                        </select>
                                    </div>
                                    <div class="col-6">
                                        <label for="syncYear" class="form-label">Year</label>
                                        <input type="number" class="form-control" id="syncYear" @bind="syncYear" min="2020" max="2030" />
                                    </div>
                                </div>

                                <button class="btn btn-primary w-100" @onclick="SyncWeeklyGames" disabled="@isSyncingWeekly">
                                    @if (isSyncingWeekly)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                        <span>Syncing...</span>
                                    }
                                    else
                                    {
                                        <span>üîÑ Sync Week @syncWeek</span>
                                    }
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="card shadow-sm h-100">
                            <div class="card-body">
                                <h5 class="card-title">Sync Weekly Results</h5>
                                <p class="text-muted">Pull final scores from completed games.</p>

                                <div class="row mb-3">
                                    <div class="col-6">
                                        <label for="syncResultsWeek" class="form-label">Week</label>
                                        <select class="form-select" id="syncResultsWeek" @bind="syncResultsWeek">
                                            @for (int i = 1; i <= 17; i++)
                                            {
                                                <option value="@i">Week @i</option>
                                            }
                                        </select>
                                    </div>
                                    <div class="col-6">
                                        <label for="syncResultsYear" class="form-label">Year</label>
                                        <input type="number" class="form-control" id="syncResultsYear" @bind="syncResultsYear" min="2020" max="2030" />
                                    </div>
                                </div>

                                <button class="btn btn-info w-100 text-white" @onclick="SyncWeeklyResults" disabled="@isSyncingResults">
                                    @if (isSyncingResults)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                        <span>Syncing...</span>
                                    }
                                    else
                                    {
                                        <span>üìä Sync Results</span>
                                    }
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="card shadow-sm h-100">
                            <div class="card-body">
                                <h5 class="card-title">Sync Bowl Games</h5>
                                <p class="text-muted">Pull bowl game lines and spreads from CFBD.</p>

                                <div class="mb-3">
                                    <label for="syncBowlYear" class="form-label">Bowl Season Year</label>
                                    <input type="number" class="form-control" id="syncBowlYear" @bind="syncBowlYear" min="2020" max="2030" />
                                </div>

                                <button class="btn btn-success w-100" @onclick="SyncBowlGames" disabled="@isSyncingBowl">
                                    @if (isSyncingBowl)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                        <span>Syncing...</span>
                                    }
                                    else
                                    {
                                        <span>üèÜ Sync Bowl Games</span>
                                    }
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card shadow-sm mt-4">
                    <div class="card-body">
                        <h5 class="card-title">üí° About CFBD Sync</h5>
                        <ul class="mb-0">
                            <li>Data is pulled from the <a href="https://collegefootballdata.com" target="_blank">College Football Data API</a></li>
                            <li>Spreads are automatically converted (positive line on home team = away team is favorite)</li>
                            <li>Existing games with matching teams are updated; new games are created</li>
                            <li>Requires <code>CFBD_API_KEY</code> environment variable to be configured</li>
                            <li>Free tier allows 1,000 requests/month</li>
                        </ul>
                    </div>
                </div>
            }
        </div>
    </div>
</div>