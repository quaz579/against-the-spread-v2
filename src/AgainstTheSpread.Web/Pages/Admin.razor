@page "/admin"
@using AgainstTheSpread.Web.Services
@using Microsoft.AspNetCore.Components.Forms
@using System.Text.Json
@inject ApiService ApiService
@inject IJSRuntime JS
@inject HttpClient Http
@inject NavigationManager Navigation
@inject ILogger<Admin> Logger

<PageTitle>Admin - Upload Lines</PageTitle>

<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <h1 class="mb-4">üèà Admin - Upload Weekly Lines</h1>

            @if (!isAuthenticated)
            {
                <div class="card shadow-sm">
                    <div class="card-body text-center py-5">
                        <h3 class="mb-4">üîê Admin Access Required</h3>
                        <p class="text-muted mb-4">Please sign in with your Google account to access admin features.</p>
                        <button class="btn btn-primary btn-lg" @onclick="Login">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                class="bi bi-google me-2" viewBox="0 0 16 16">
                                <path
                                    d="M15.545 6.558a9.4 9.4 0 0 1 .139 1.626c0 2.434-.87 4.492-2.384 5.885h.002C11.978 15.292 10.158 16 8 16A8 8 0 1 1 8 0a7.7 7.7 0 0 1 5.352 2.082l-2.284 2.284A4.35 4.35 0 0 0 8 3.166c-2.087 0-3.86 1.408-4.492 3.304a4.8 4.8 0 0 0 0 3.063h.003c.635 1.893 2.405 3.301 4.492 3.301 1.078 0 2.004-.276 2.722-.764h-.003a3.7 3.7 0 0 0 1.599-2.431H8v-3.08z" />
                            </svg>
                            Sign in with Google
                        </button>
                    </div>
                </div>
            }
            else if (!isAuthorized)
            {
                <div class="alert alert-warning">
                    <h4>‚ö†Ô∏è Access Denied</h4>
                    <p>You are signed in as <strong>@userEmail</strong>, but you don't have admin privileges.</p>
                    <p>Please contact the site administrator if you believe this is an error.</p>
                    <button class="btn btn-secondary mt-2" @onclick="Logout">Sign Out</button>
                </div>
            }
            else
            {
                <div class="alert alert-info">
                    Signed in as: <strong>@userEmail</strong>
                    <button class="btn btn-sm btn-outline-secondary float-end" @onclick="Logout">Sign Out</button>
                </div>

                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        <strong>Error!</strong> @errorMessage
                        <button type="button" class="btn-close" @onclick="ClearError"></button>
                    </div>
                }

                @if (!string.IsNullOrEmpty(successMessage))
                {
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                        <strong>Success!</strong> @successMessage
                        <button type="button" class="btn-close" @onclick="ClearSuccess"></button>
                    </div>
                }

                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title">Upload Game Lines</h5>
                        <p class="text-muted">Upload an Excel file (.xlsx) containing the weekly betting lines.</p>

                        <div class="mb-3">
                            <label for="weekInput" class="form-label">Week Number</label>
                            <input type="number" class="form-control" id="weekInput" @bind="weekNumber" min="1" max="17"
                                placeholder="Enter week number (1-17)" />
                        </div>

                        <div class="mb-3">
                            <label for="yearInput" class="form-label">Year</label>
                            <input type="number" class="form-control" id="yearInput" @bind="year" min="2024" max="2030"
                                placeholder="Enter year" />
                        </div>

                        <div class="mb-3">
                            <label for="fileInput" class="form-label">Excel File</label>
                            <InputFile class="form-control" id="fileInput" OnChange="OnFileSelected"
                                accept=".xlsx,.xls,.csv" />
                            <div class="form-text">
                                Select an Excel file with game lines. Must include: Team, Opponent, Line, Date/Time.
                            </div>
                        </div>

                        @if (selectedFile != null)
                        {
                            <div class="alert alert-info">
                                <strong>Selected file:</strong> @selectedFile.Name (@(selectedFile.Size / 1024) KB)
                            </div>
                        }

                        <button class="btn btn-primary btn-lg w-100" @onclick="UploadFile"
                            disabled="@(isUploading || selectedFile == null || weekNumber < 1)">
                            @if (isUploading)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                <span>Uploading...</span>
                            }
                            else
                            {
                                <span>üì§ Upload Lines</span>
                            }
                        </button>
                    </div>
                </div>

                <div class="card shadow-sm mt-4">
                    <div class="card-body">
                        <h5 class="card-title">üìã File Format Requirements</h5>
                        <ul class="mb-0">
                            <li>Excel file (.xlsx or .xls) or CSV</li>
                            <li>Must contain columns: Team, Opponent, Line, Date/Time</li>
                            <li>Line format: "Team -7.5" or "Opponent +3.5"</li>
                            <li>Date format: "MM/DD/YYYY HH:MM" or similar</li>
                            <li>Each row represents one game</li>
                        </ul>
                    </div>
                </div>

                <div class="card shadow-sm mt-4">
                    <div class="card-body">
                        <h5 class="card-title">üí° Tips</h5>
                        <ul class="mb-0">
                            <li>Upload files on Sunday evening for the upcoming week</li>
                            <li>Double-check the week number before uploading</li>
                            <li>You can re-upload to overwrite existing lines</li>
                            <li>Users will see the new lines immediately after upload</li>
                        </ul>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@code {
    private bool isAuthenticated = false;
    private bool isAuthorized = false;
    private string? userEmail;
    private int weekNumber = 1;
    private int year = DateTime.Now.Year;
    private IBrowserFile? selectedFile;
    private bool isUploading = false;
    private string? errorMessage;
    private string? successMessage;

    protected override async Task OnInitializedAsync()
    {
        await CheckAuthStatus();
    }

    private async Task CheckAuthStatus()
    {
        try
        {
            // Create a new HttpClient with the host base address for auth endpoints
            using var authClient = new HttpClient { BaseAddress = new Uri(Navigation.BaseUri) };

            var response = await authClient.GetAsync(".auth/me");
            if (response.IsSuccessStatusCode)
            {
                var json = await response.Content.ReadAsStringAsync();
                Logger.LogDebug("Auth response: {AuthResponse}", json);

                var authInfo = JsonSerializer.Deserialize<AuthMeResponse>(json, new JsonSerializerOptions
                {
                    PropertyNameCaseInsensitive = true
                });

                if (authInfo?.ClientPrincipal != null)
                {
                    isAuthenticated = true;
                    userEmail = authInfo.ClientPrincipal.UserDetails;

                    // For now, assume authenticated users are authorized
                    // The backend will do the actual email validation
                    isAuthorized = true;
                }
                else
                {
                    Logger.LogWarning("No client principal in auth response");
                }
            }
            else
            {
                Logger.LogWarning("Auth check failed with status code: {StatusCode}", response.StatusCode);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error checking authentication status");
        }
    }

    private void Login()
    {
        Navigation.NavigateTo("/.auth/login/google?post_login_redirect_uri=/admin", true);
    }

    private void Logout()
    {
        Navigation.NavigateTo("/.auth/logout?post_logout_redirect_uri=/", true);
    }

    private void OnFileSelected(InputFileChangeEventArgs e)
    {
        selectedFile = e.File;
        ClearMessages();
    }

    private async Task UploadFile()
    {
        if (selectedFile == null || weekNumber < 1)
            return;

        isUploading = true;
        ClearMessages();

        try
        {
            // Read file stream
            using var stream = selectedFile.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024); // 10 MB limit
            using var memoryStream = new MemoryStream();
            await stream.CopyToAsync(memoryStream);
            memoryStream.Position = 0;

            // Upload to API
            var response = await ApiService.UploadLinesAsync(weekNumber, year, memoryStream, selectedFile.Name);

            if (response?.Success == true)
            {
                successMessage = response.Message;
                selectedFile = null;
            }
            else
            {
                errorMessage = "Failed to upload file. Please check the format and try again.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error uploading file: {ex.Message}";
        }
        finally
        {
            isUploading = false;
        }
    }

    private void ClearMessages()
    {
        errorMessage = null;
        successMessage = null;
    }

    private void ClearError()
    {
        errorMessage = null;
    }

    private void ClearSuccess()
    {
        successMessage = null;
    }

    // Helper classes for SWA auth
    private class AuthMeResponse
    {
        public ClientPrincipal? ClientPrincipal { get; set; }
    }

    private class ClientPrincipal
    {
        public string? IdentityProvider { get; set; }
        public string? UserId { get; set; }
        public string? UserDetails { get; set; }
        public List<string>? UserRoles { get; set; }
    }
}