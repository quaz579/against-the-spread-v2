# Agent Development Guide - Against The Spread

## Project Overview

This is a Progressive Web Application (PWA) for managing a weekly college football pick'em game. 

**MVP Scope:**
- **Admin**: Manually upload weekly lines Excel file to Azure Blob Storage (no web UI needed for MVP)
- **User**: Web interface to view available games, select 6 games, and download formatted Excel picks file
- **Focus**: Solve the mobile problem - make picks on the go instead of requiring a computer

## Technology Stack

- **Frontend**: Blazor WebAssembly PWA
- **Backend**: Azure Functions (C# .NET 8)
- **Storage**: Azure Blob Storage
- **Excel Processing**: EPPlus
- **Infrastructure**: Terraform
- **CI/CD**: GitHub Actions
- **Testing**: xUnit, bUnit (Blazor), Moq

## Repository Structure

```
against-the-spread/
├── .github/
│   └── workflows/
│       ├── build-test.yml          # Build and test on PR
│       └── deploy.yml               # Deploy to Azure on merge to main
├── src/
│   ├── AgainstTheSpread.Functions/  # Azure Functions API (user endpoints only)
│   ├── AgainstTheSpread.Web/        # Blazor WASM PWA (user interface only)
│   ├── AgainstTheSpread.Core/       # Shared models and utilities
│   └── AgainstTheSpread.Tests/      # Unit and integration tests
├── infrastructure/
│   ├── terraform/
│   │   ├── main.tf
│   │   ├── variables.tf
│   │   ├── outputs.tf
│   │   └── environments/
│   │       ├── dev.tfvars
│   │       └── prod.tfvars
│   └── scripts/
│       ├── deploy-dev.sh
│       ├── deploy-prod.sh
│       └── upload-lines.sh         # Helper script for admin to upload lines
├── reference-docs/                  # Excel examples and rules
├── .agents.md                       # This file
├── implementation-plan.md           # Detailed step-by-step plan
├── README.md
└── .gitignore
```

## Development Workflow

### Phase 1: Infrastructure Setup
1. Configure Terraform for Azure resources (Storage Account, Static Web App, Functions)
2. Create dev and prod environments
3. Create helper script for admin to upload lines to blob storage
4. Validate resources are created correctly

### Phase 2: Core Library Development
1. Define data models (Game, WeeklyLines, UserPicks)
2. Create Excel parsing utilities (read uploaded lines)
3. Create Excel generation utilities (generate picks in exact format)
4. Write comprehensive unit tests for all core logic
5. Validate with real sample Excel files

### Phase 3: Backend API Development (Minimal)
1. Create Azure Functions project structure
2. Implement user endpoints:
   - GET /api/lines/{week} - Read Excel from blob, parse, return games
   - POST /api/picks - Receive picks, generate Excel, return file
3. Write unit tests for endpoints
4. Test locally with Azurite

### Phase 4: Frontend PWA Development
1. Create Blazor WASM project with PWA template
2. Implement single user interface:
   - List available weeks (read from blob storage)
   - Display games for selected week
   - Allow selection of exactly 6 games
   - Input name
   - Download formatted Excel picks
3. Add PWA manifest and service worker
4. Write component tests with bUnit
5. Test on mobile devices

### Phase 5: Integration Testing
1. End-to-end testing with real Azure resources (dev)
2. Test: Admin uploads via script → User picks games → Downloads Excel
3. Test PWA installation on mobile
4. Performance testing

### Phase 6: CI/CD Setup
1. Create GitHub Actions for build/test
2. Create GitHub Actions for deployment
3. Set up environment secrets
4. Test deployment pipeline
5. Document deployment process

## Agent Instructions

### When Building Features

1. **Always start with tests**: Write failing tests first (TDD approach)
2. **Compile frequently**: After each significant change, compile to catch errors early
3. **Run tests frequently**: After implementing code, run tests to validate
4. **Small commits**: Make small, logical commits with clear messages
5. **Documentation**: Update README/docs as you build features

### Testing Strategy

**CRITICAL: All tests must pass before any task is complete.**

**Unit Tests:**
- All business logic in Core library
- All service methods in Functions
- All utility functions
- Mock external dependencies (Blob Storage, HTTP)
- Run with: `dotnet test`

**End-to-End Tests (Playwright):**
- Complete user flows including authentication
- Admin upload via SWA CLI mock auth
- User picks and Excel download validation
- Run with: `./start-e2e.sh && cd tests && npm test`
- Documentation: `tests/README.md`

**Integration Tests:**
- API endpoints with Azurite
- Excel parsing with real sample files
- Excel generation with validation

**Component Tests:**
- Blazor components with bUnit
- User interaction flows
- Form validation

**Test Naming Convention:**
```csharp
[Fact]
public void MethodName_Scenario_ExpectedBehavior()
{
    // Arrange
    // Act
    // Assert
}
```

### Build & Test Commands

**Restore and Build:**
```bash
dotnet restore
dotnet build
```

**Run All Unit Tests:**
```bash
dotnet test
```

**Run E2E Tests (Playwright):**
```bash
# Start E2E environment (Azurite, Functions, Web, SWA CLI)
./start-e2e.sh

# Run Playwright tests
cd tests && npm test

# Stop E2E environment when done
cd .. && ./stop-e2e.sh
```

**E2E Test Commands:**
```bash
cd tests
npm test              # Run all tests
npm run test:headed   # Run with visible browser
npm run test:debug    # Debug interactively
npm run test:report   # View HTML report
```

**Run Specific Test Project:**
```bash
dotnet test src/AgainstTheSpread.Tests/AgainstTheSpread.Tests.csproj
```

**Run with Coverage:**
```bash
dotnet test /p:CollectCoverage=true /p:CoverageReportsDir=./coverage
```

**Run Azure Functions Locally:**
```bash
cd src/AgainstTheSpread.Functions
func start
```

**Run Blazor WASM Locally:**
```bash
cd src/AgainstTheSpread.Web
dotnet run
```

### Terraform Commands

**Initialize:**
```bash
cd infrastructure/terraform
terraform init
```

**Plan (Dev):**
```bash
terraform plan -var-file="environments/dev.tfvars"
```

**Apply (Dev):**
```bash
terraform apply -var-file="environments/dev.tfvars"
```

**Destroy (Dev):**
```bash
terraform destroy -var-file="environments/dev.tfvars"
```

## Key Design Decisions

### 1. Monorepo Structure
- Single repository for frontend, backend, infrastructure, and tests
- Simplifies versioning and deployment
- Easier CI/CD configuration

### 2. Shared Core Library
- `AgainstTheSpread.Core` contains models, interfaces, and utilities
- Referenced by both Functions and Web projects
- Ensures type safety across the stack

### 3. Excel Processing Strategy
- Admin manually uploads Excel to Blob Storage using Azure CLI or helper script
- User API reads Excel directly from blob when requested
- Parse Excel to JSON in-memory for API response
- User selects games → Generate Excel in exact "Weekly Picks Example" format → Download
- No intermediate storage needed - all done in-memory

### 4. Authentication Strategy
- MVP: No authentication (trust-based, same as current email system)
- Future: Azure AD B2C for user management if needed

### 5. Storage Strategy
```
Blob Container: gamefiles
└── lines/
    ├── week-1.xlsx          # Manually uploaded by admin
    ├── week-2.xlsx
    └── week-N.xlsx
```

No picks storage needed for MVP - users download and email themselves.

### 6. API Endpoints

**User Endpoints (Only):**
- `GET /api/weeks` - List available weeks (list blobs in storage)
- `GET /api/lines/{week}` - Get games for specific week (read & parse Excel)
- `POST /api/picks` - Submit picks and generate Excel download (in-memory, returns file)

**Admin:**
- No API needed - uses Azure CLI or helper script to upload files directly to blob storage

## Error Handling Strategy

### API Level
- Return appropriate HTTP status codes
- Include descriptive error messages
- Log errors to Application Insights

### Frontend Level
- Display user-friendly error messages
- Handle network failures gracefully
- Show loading states during API calls

### Validation
- Validate exactly 6 picks selected
- Validate week number exists
- Validate Excel file format on upload

## Testing with Sample Data

Use the reference documents in `reference-docs/`:
- `Week 1 Lines.xlsx` - Sample input for admin upload
- `Week 2 Lines.xlsx` - Second week sample
- `Weekly Picks Example.xlsx` - Expected output format

### Test Scenarios

1. **Happy Path**: Upload week 1 lines → Select 6 games → Download picks Excel
2. **Validation**: Try to select fewer/more than 6 games
3. **Error Handling**: Upload invalid Excel format
4. **Mobile**: Test PWA installation and usage on mobile
5. **Concurrent Users**: Multiple users selecting games simultaneously

## Performance Considerations

### Frontend
- Lazy load components where possible
- Cache game data in browser storage
- Minimize bundle size

### Backend
- Use streaming for Excel generation (large files)
- Cache parsed game data (avoid re-parsing Excel)
- Set appropriate CORS policies

### Storage
- Use Blob Storage SAS tokens for direct download
- Set appropriate cache headers
- Compress Excel files if needed

## Security Considerations

### MVP (No Auth)
- Rate limiting on API endpoints
- Validate all inputs
- Function keys for admin endpoints
- CORS configuration

### Future (With Auth)
- Azure AD B2C integration
- Role-based access (Admin vs User)
- Audit logging for admin actions
- User-specific pick history

## Deployment Strategy

### Environments
1. **Development**: Used for feature development and testing
2. **Production**: Live application for all users

### Deployment Process
1. Commit code to feature branch
2. Create PR → GitHub Actions runs build/test
3. Merge to main → GitHub Actions deploys to dev
4. Manual approval → Deploy to production

### Rollback Strategy
- Keep previous Terraform state
- Tag releases in GitHub
- Easy rollback via Terraform or Azure Portal

## Monitoring and Logging

### Application Insights
- Track API request/response times
- Monitor error rates
- Track custom events (uploads, downloads)

### Alerts
- Set up alerts for high error rates
- Monitor storage usage
- Track function execution failures

## Future Enhancements (Post-MVP)

1. **User Authentication**: Azure AD B2C
2. **Pick History**: Show user's past picks and results
3. **Leaderboard**: Track weekly winners and total wins
4. **Automated Scoring**: Parse game results and calculate winners
5. **Push Notifications**: Remind users to submit picks
6. **Bowl Games**: Confidence points system
7. **Playoff Bracket**: Tournament-style picks
8. **Admin Dashboard**: View all submissions, generate reports
9. **Mobile Apps**: Native iOS/Android using .NET MAUI

## Agent Checkpoints

After completing each phase or significant change:
1. ✅ Run `dotnet build` - ensure compilation succeeds
2. ✅ Run `dotnet test` - ensure all unit tests pass (156+ tests)
3. ✅ Run E2E tests - `./start-e2e.sh && cd tests && npm test` (2+ tests)
4. ✅ Test locally - validate functionality works as expected
5. ✅ Commit changes with descriptive message
6. ✅ Update documentation if any decisions changed

**A task is NOT complete until both unit tests AND E2E tests pass.**

**When to add new E2E tests:**
- New user-facing features (admin or picks page)
- Modified user flows or interactions
- Changed API endpoints used by the UI
- Updated authentication or authorization

**E2E Test Documentation:**
- `tests/README.md` - Complete guide (START HERE)
- `tests/specs/full-flow.spec.ts` - Main test scenarios
- `tests/pages/admin-page.ts` - Admin page object model
- `tests/pages/picks-page.ts` - Picks page object model

## Common Commands Reference

```bash
# Create new project
dotnet new classlib -n AgainstTheSpread.Core
dotnet new azurefunc -n AgainstTheSpread.Functions
dotnet new blazorwasm -n AgainstTheSpread.Web
dotnet new xunit -n AgainstTheSpread.Tests

# Add project references
dotnet add reference ../AgainstTheSpread.Core/AgainstTheSpread.Core.csproj

# Add NuGet packages
dotnet add package EPPlus
dotnet add package Azure.Storage.Blobs
dotnet add package Moq
dotnet add package FluentAssertions
dotnet add package bUnit

# Solution management
dotnet new sln -n AgainstTheSpread
dotnet sln add src/**/*.csproj

# Azure CLI (for local testing)
az login
az account set --subscription <subscription-id>
az storage account create --name <storage-name> --resource-group <rg-name>

# GitHub CLI (for secrets)
gh secret set AZURE_SUBSCRIPTION_ID
gh secret set AZURE_CREDENTIALS
```

## Questions to Address During Development

- Should we store submitted picks in Blob Storage or just generate on-the-fly?
- Do we need to track who submitted picks for the current week?
- Should the admin be able to edit/delete uploaded weeks?
- What happens if someone tries to download picks before lines are uploaded?
- Should we validate that the uploaded Excel matches the expected format strictly?

## Success Criteria

The MVP is complete when:
- ✅ Admin can upload weekly lines via web interface
- ✅ User can view available games on mobile
- ✅ User can select exactly 6 games
- ✅ User can download Excel file in correct format
- ✅ PWA is installable on mobile devices
- ✅ All tests pass
- ✅ Infrastructure is deployed via Terraform
- ✅ CI/CD pipeline successfully deploys to dev
- ✅ Application is accessible via public URL
- ✅ Costs remain in free tier or near-zero

---

**Remember**: Build incrementally, test frequently, commit often. Focus on making the MVP work perfectly before adding enhancements.
